<!doctype html>
<html lang="en">
  <head>
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">

    <title>Chronos API Documentation</title>
  </head>

  <body>
    <div class="container-fluid">
       <h1 class="h2">Chronos API Documentation</h1>
       <hr>
    </div>

    <!-- Big list of API parameters -->
    <div class="container-fluid">
      <table class="table table-striped table-sm">
        <thead>
          <tr class="row">
            <th class="col-sm-2">Name</th>
            <th class="col-sm-1">Type</th>
            <th class="col-sm-6">Description</th>
            <th class="col-sm-3">Value</th>
          </tr>
        </thead>
        <tbody id="parameters">
          <!-- To be filled in by javascript -->
        </tbody>
      </table>
    </div>

    <!-- Optional JavaScript -->
    <!-- jQuery first, then Popper.js, then Bootstrap JS -->
    <script src="/js/jquery-3.3.1.js" crossorigin="anonymous"></script>
    <script src="/js/popper.min.js" crossorigin="anonymous"></script>
    <script src="/js/bootstrap.min.js" crossorigin="anonymous"></script>
    
    <!-- Generate the API documentation using JavaScript -->
    <script>
      function updateValues(result) {
        for (let name in result) {
          let row = document.getElementById(name);
          let value = document.createElement("pre");
          value.setAttribute("class", "pre-scrollable");
          value.innerHTML = JSON.stringify(result[name], null, 2);
          row.cells[3].innerHTML = "";
          row.cells[3].appendChild(value);
        }
      }

      function describeType(type) {
        if (!(typeof type === 'string' || type instanceof String)) {
          return "unknown";
        }

        if (type == "a{sv}") return "dictionary";
        if (type == "i") return "int";
        if (type == "s") return "string";
        if (type == "b") return "boolean";
        if (type == "d") return "float";
        
        /* If the type is an array, use some recursion. */
        if (type.charAt(0) == 'a') {
          return "array[" + describeType(type.slice(1)) + "]";
        }

        /* Otherwise, we can't make sense of this D-Bus type */
        return "unknown";
      }

      function buildParam(table, name, data) {
        /* Create the table row for the parameter*/
        let row = table.insertRow();
        row.id = name;
        row.setAttribute("class", "row");

        let namecell = document.createElement("code");
        namecell.innerText = name;

        let typecell = document.createElement("code");
        typecell.innerText = describeType(data['type']);

        /* Describe the parameter. */
        let ncell = row.insertCell(0);
        ncell.appendChild(namecell);
        ncell.setAttribute("class", "col-sm-2");

        let tcell = row.insertCell(1);
        tcell.appendChild(typecell);
        tcell.setAttribute("class", "col-sm-1");

        let dcell = row.insertCell(2);
        dcell.innerText = data['doc'];
        dcell.setAttribute("class", "col-sm-6");

        let vcell = row.insertCell(3);
        vcell.innerText = "TODO: Value";
        vcell.setAttribute("class", "col-sm-3");
      }

      function buildAPIDocs(result) {
        let ptable = document.getElementById("parameters");
        let keys = Object.keys(result).sort();
        keys.forEach(function(name) { buildParam(ptable, name, result[name])} );

        /* Retrieve the current values for all the parameters */
        fetch('/control/get', {
          body: JSON.stringify(keys),
          headers: {"Content-Type": "application/json"},
          method: "POST",
          cache: "no-cache",
        }).then((response) => response.json()).then((data) => { updateValues(data); })
      }

      /* Build the list of parameters */
      $.getJSON("/control/describe", buildAPIDocs);

      /* Subscribe to the event stream to show parameter value changes. */
      evtSource = new EventSource("/control/subscribe");
      evtSource.addEventListener("notify", function(event) {updateValues(JSON.parse(event.data));});
    </script>
  </body>
</html>
