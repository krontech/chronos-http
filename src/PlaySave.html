<!DOCTYPE html>
<html><head>
<meta name="viewport" content="width=device-width, initial-scale=1" charset="utf-8"/>
<title>Chronos</title>


<link rel="stylesheet" href="css/fontFile.css"> 

<link rel="styleSheet" href="css/sizeAndSpacing.css">
<link id="themeSelection" rel="styleSheet" href="css/defaultTheme.css">
<link id="windozeFixer" rel="styleSheet" href="">

<style>

/******** Specific to this page ********/

#playButton	{ width: 170px; height: 35px; padding: 19.5px 0; line-height: 35px; }

#saveVideoButton { float: right; }
#saveVideoButton.disabled { /* when the save button is disabled */
/*	box-shadow: 0 0 3px 3px #a00; */
	background-color: #222;
	text-decoration: line-through; /* cross out the save button */
}


#frameMarkStart, #frameMarkEnd { width: 100px; } /* set the width of these buttons */
#frameStepB, #frameStepF { width: 135px; }

#playBackBox { max-width: 283px; }



#frameMarkStart {
	box-shadow: -3px 3px 0 0 inset green;
}
#frameMarkEnd {
	box-shadow: 3px 3px 0 0 inset #a00;
}
#frameMarkStart:hover {
	box-shadow: -3px 3px 0 0 inset #2f2;
}
#frameMarkEnd:hover {
	box-shadow: 3px 3px 0 0 inset #f22;
}


#refreshAllBox { max-width: 278px; }
#refreshButton { float: right; }


#imageDisplay { line-height: 430px; }


/*@media screen and (max-width: 3000px) {
	.rightContainer { box-shadow: 0 0 3px 3px inset white; }
} */


@media screen and (min-width: 1830px) {
	.rightContainer { max-width: 990px; }
	#storageDeviceBox { clear: left; min-height: 211px; }
}


@media screen and (max-width: 1830px) { /* change formatting when screen size is narrower than this */
	.rightContainer { max-width: 690px; }
}


@media screen and (min-width: 1530px) {
	#frameCountBox { padding-bottom: 8.5px; }
}

@media screen and (min-width: 1530px) and (max-width: 1830px) {
	#playBackBox { min-height: 191px; }
	#saveAsBox { min-width: 283px; }
}

@media screen and (max-width: 1530px) { /* change formatting when screen size is narrower than this */
	.rightContainer { max-width: 375px; }
}


@media screen and (max-width: 1215px) { /* change formatting when screen size is narrower than this */
	.rightContainer { max-width: 303px; }
}

@media screen and (max-width: 1142px) { /* change formatting when screen size is narrower than this */
	.rightContainer, .leftContainer, .videoDisplay { max-width: 100%; }
	.leftContainer { margin: 0; }
	.Text-bar { margin: 4px 0 2px 0; }
}


@media screen and (max-width: 1142px) and (min-width: 1007px) {
	#storageDeviceBox { clear: left; }
}

@media screen and (max-width: 1140px) and (min-width: 684px) {
	#frameCountBox { padding-bottom: 8.5px; }
	#playBackBox { min-height: 191px; }
}

@media screen and (max-width: 1111px) { /* change formatting when screen size is narrower than this */
	#playSave { display: none; } /* hide the main button */
}

@media screen and (max-width: 1006px) and (min-width: 684px) {
	#saveAsBox { min-width: 283px; clear: left;}
}

@media screen and (max-width: 940px) { /* change formatting when screen size is narrower than this */
	#help { display: none; } /* hide the help button */

	body { margin: 0; }
}

@media screen and (max-width: 705px) { /* change formatting when screen size is narrower than this */
	#storage { display: none; } /* hide the storage button */

	.subTitle { display: none; }
}

@media screen and (max-width: 683px) {
	#videoSettingsBox, #playBackBox, #storageDeviceBox,
	#saveAsBox, #downloadBox { clear: left; }
}

@media screen and (max-width: 542px) { /* change formatting when screen size is narrower than this */
	#settings { display: none; } /* hide the playSave button */

	#saveProgress { bottom: 17%; left: 5%; }
	#videoStateOverlay { bottom: 199%; }
	#overlayButtons { bottom: 106%; }
}

@media screen and (max-width: 455px) { /* change formatting when screen size is narrower than this */
	.titleImage img { width: 100%; height: auto; }
}

@media screen and (max-width: 365px) { /* change formatting when screen size is narrower than this */
	#main { display: none; } /* hide the settings button */

	#menu { width: 90%; }
}



</style>
</head>


<body onclick="">

	<div class="header">
		<div class="titleImage">
			<img id="logoImage" src="Chronos High Speed logo.png">
		</div>

		<!-- <b class="title">&nbsp;CHRONOS</b> -->
		<div class="subTitle">by <a href="https://www.krontech.ca" target="_blank">Kron Technologies</a></div>
	</div>

 <div class="mainContainer"> 

	
	<div class="heading-bar">
		<a id="main" href="./"> <div class="homeIcon"></div> Main </a>
		<a id="playSave" class="active"> <div class="playIcon"></div> Play & Save </a>
<!--		<a id="storage"> <div class="saveIcon"></div> Storage </a>
-->
		<a id="settings" href="settings.html"> <div class="settingsIcon"></div> Settings </a>
		<a id="help" href="/apidoc/"> <div class="helpIcon">?</div> Help / About </a>

		<a id="menu" onclick="toggler(this)" class="menuClickOk"> <div class="menuIcon"></div> Menu </a>
		<div id="menuList" onmouseover="menuKeeper()" class="menuContainer menuClickOk">
			<a href="/"> Record (Main) </a>
			<a href="PlaySave.html"> Play & Save </a>
<!--			<a> About Camera </a>
-->
			<a href="settings.html"> Camera Settings </a>
<!--
			<a> Triggers & IO </a>
-->
			<a href="/apidoc/"> Documentation </a>
			<a onclick="dropDownSelect(this)">Play Mode</a>
			<a onclick="dropDownSelect(this)">Record Mode</a>
			<a onclick="dropDownSelect(this)">Debug Tools</a>
		</div>

	</div>


	<div class="leftContainer">

		<div id="videoDisplay" class="videoDisplay">
			<img id="imageDisplay" alt="Screenshot Display">
			<div id="saveProgress" class="progressBar hidden">
				<div id="videoStateOverlay" class="stateNotice">Saving Video</div>
				<div id="overlayButtons" class="overlayButtons">
					<a id="overlayNavigateButton" href="/">Record Screen</a>
					<a id="overlayPlayModeButton" onclick="justRunSomething(this)">Play Mode</a>
				</div>
				<div id="saveProgressFill" class="progressBarFill"></div>
				Progress
			</div>
		</div>

		<div id="timelineHolder" class="timelineHolder">
			<input id="startMarker" class="timelineMarker" oninput="justRunSomething(this)" type="range" min="0" max="100" value="15" step="1" onmouseup="frameChange(this)">
			<input id="endMarker" class="timelineMarker" oninput="justRunSomething(this)" type="range" min="0" max="100" value="85" step="1" onmouseup="frameChange(this)">
			<div id="startEndFill"></div>
			<input id="timeLine" class="timeline" oninput="sliderDragged(this)" type="range" step="1" onmouseup="frameChange(this)">
		</div>

		<div class="Text-bar">
			<a id="playButton" onclick="toggler(this)"><div class="playIcon"></div>&ensp;Play</a>
			<div id="battery" class="no-click">
				<div id="batteryContainer" class="battery">
					<div id="battery-level"></div>
				</div>
				<span id="battery%">0%</span>
			</div>
			<a id="frameMarkStart" onclick="justRunSomething(this)">Mark Start</a>
			<a id="frameStepB" onclick="justRunSomething(this)">Step Backward</a>
			<a id="frameStepF" onclick="justRunSomething(this)">Step Forward</a>
			<a id="frameMarkEnd" onclick="justRunSomething(this)">Mark End</a>
		</div>

	</div>



	<div class="rightContainer">

		<div id="frameCountBox" class="horizLayout">
			<b> Frames </b>
			<br>
			Frame:
			<input type="number" id="currentFrameNum" oninput="justRunSomething(this)" min="0" value="1" onfocusout="frameChange(this)"> / <span id="totalFramesNum">#</span>
			<br>
			Starting Frame:
			<input type="number" id="startFrameNum" oninput="justRunSomething(this)" min="0" onfocusout="frameChange(this)">
			<br>
			Ending Frame:
			<input type="number" id="endFrameNum" oninput="justRunSomething(this)" min="0" onfocusout="frameChange(this)">
			<br>
			Length:
			<input type="number" id="frameLengthNum" oninput="justRunSomething(this)" min="0" onfocusout="frameChange(this)">
		</div>

		<div id="videoSettingsBox" class="horizLayout">
			<b> Video Settings </b>
			<br>
			Video framerate:
			<input type="number" id="saveFPSNum" min="1" max="60" step="1" value="60" onChange="boundInput(this)"> fps
			<br>
			Bits per pixel:
			<input type="number" id="bitsPerPixelNum" min="0.25" step="0.05" max="2.0" value="0.70" onChange="boundInput(this)">
			<br>
			Max Bitrate:
			<input type="number" id="maxBitrateNum" min="1" max="60" step="1" value="40" onChange="boundInput(this)"> Mbps
			<br>
			Text Overlay:
			<a id="textOverlayButton" class="button" onclick="toggler(this)"> Off </a>
		</div>

		<div id="playBackBox" class="horizLayout">
			<b> Play Speed </b>
			<input type="number" id="playBackRateNum" min="0" max="1920" step="1" value="60" onChange="boundInput(this)"> fps
			<br>
			<span class="instruction">Note that the image displayed on this page only updates once per second</span>
		</div>

		<div id="storageDeviceBox" class="horizLayout">
			<b> Storage Device </b>
			<br>
			<div id="storageLocation" class="selectContainerHolder" onclick="">Location<div id="storageLocationInner" class="selectContainer">
				<a onclick="dropDownSelect(this)"> No Storage Connected </a>
				<a onclick="dropDownSelect(this)">Refresh</a>
			</div></div>
			<div class="smallPercentBar" id="storageBar"><div class="smallPercentBarFill"></div></div>
			Size: <span id="storageSize"></span>
			<br>
			Used: <span id="storageUsed"></span>
			<br>
			Available: <span id="storageAvailable"></span>
		</div>


		<div id="saveAsBox" class="horizLayout">
			<b> Save Video </b>
			<br>
			<input type="text" id="fileName" placeholder="File Name">
			<br>
			<span class="instruction">Leave empty to use autoname</span>
			<br><br>
			<div id="saveFormat" class="selectContainerHolder" onclick="">File Format<div id="saveFormatInner" class="selectContainer">
				<a onclick="dropDownSelect(this)">H.264 (mp4)</a>
				<a onclick="dropDownSelect(this)">CinemaDNG (raw)</a>
				<a onclick="dropDownSelect(this)">TIFF (images)</a>
				<a onclick="dropDownSelect(this)">TIFF RAW (images)</a>
			</div></div>
			<a id="saveVideoButton" class="button disabled" onclick="saveVideo()"> Save </a>
		</div>

		<div id="downloadBox" class="horizLayout">
			<b> Download From Camera </b>
			<br>
			<div id="fileDownloadList" class="selectContainerHolder" onclick="">Download File<div id="fileDownloadListInner" class="selectContainer">
				<a onclick="dropDownSelect(this)"> No Storage Device Selected </a>
			</div></div>
		</div>


		<div id="refreshAllBox" class="horizLayout hidden">
			<b> Refresh Parameters </b>
			<br>
			<a id="refreshButton" class="button" onclick="dropDownSelect(this)">Update</a>
			<span class="instruction">This browser does not get alerted to changes from the camera. Use this button to update this page to match the camera</span>
		</div>

	</div>


	<br>

	<div id="debugBar" class="Text-bar hidden">
		<a id="tester1" onclick="tester1func()"> tester1 </a>
		<a id="tester2" onclick="tester2func()"> tester2 </a>
		<a id="tester3" onclick="tester3func()"> tester3 </a>
		<a id="debugToggle" onclick="toggler(this)"> Display Messages </a>
		<div class="no-click"></div>
		<a onclick='theme("default")'> Default Theme </a>
		<a onclick='theme("monochrome")'> Mono Theme </a>
		<a onclick='theme("darker")'> Darker Theme </a>
		<a onclick='theme("lighter")'> Lighter Theme </a>
		<a onclick='theme("monoDark")'> Mono Dark </a>
		<a onclick='theme("newDefault")'> Light Theme2 </a>
	</div>
	<br>
	<span id="debugger">  </span>

	<span id="debugger2">  </span>
 </div>



<div id="popUpBackground" class="popUpBackground hidden">
	<div id="messageWarn" class="popUpMessage">
		<div id="somethingWeirdBox" class="horizLayout hidden">
			Something weird is happening
		</div>
		<div id="errorWhileSavingBox" class="horizLayout hidden">
			Cannont save the file
			<br>
			<a style="float: right;" class="button" onclick="dropDownSelect(this)">Ok</a>
		</div>
	</div>
</div>

<br>
<div class="matchBackground"> This page was made by Nicholas Faliszewski </div>

</body>

<script>

var DebugOnOff = false ;


function tester1func() {

}


function tester2func() {

}


function tester3func() {

}


/* check cookies */

switch (getCookie("thm")) {
	case "dt":
		theme("default") ;
		break ;

	case "mo":
		theme("monochrome") ;
		break ;

	case "dk":
		theme("darker") ;
		break ;

	case "lt":
		theme("lighter") ;
		break ;

	case "md":
		theme("monoDark") ;
		break ;

	case "l2":
		theme("newDefault") ;
		break ;
}

if (getCookie("mc") == "n") {
	dataRequester("startPlayback", '{"framerate": 0}', pageUpdate) ;
}


function getCookie(cname) {
  var name = cname + "=";
  var ca = document.cookie.split(';');
  for(var i = 0; i < ca.length; i++) {
    var c = ca[i];
    while (c.charAt(0) == ' ') {
      c = c.substring(1);
    }
    if (c.indexOf(name) == 0) {
      return c.substring(name.length, c.length);
    }
  }
  return "";
}


function setCookie (name, value) {
	var expiryDate = new Date() ;

//	expiryDate.setTime(expiryDate.getTime() + 1000*60*60*24*30) ; // add 30 days (time is in ms)
	expiryDate.setTime(expiryDate.getTime() + 1000*60*20) ; // add 20 minutes (time is in ms)

	document.cookie = name + "=" + value + "; expires=" + expiryDate.toUTCString() + "; path=/" ;
}


if (detectIE()) {
	if (DebugOnOff)
		document.getElementById("debugger2").innerHTML = "MS Browser detected" ;
	
	document.getElementById("windozeFixer").href = "css/windozeFixes.css" ;
	
	if ( (parseInt(detectIE()) <= 16) ) { // detect an older version (especially IE)
		if (DebugOnOff)
			document.getElementById("debugger2").innerHTML += " -- Seems to be Internet Explorer" ;
	}
}


function detectIE() {
  var ua = window.navigator.userAgent;

  // Test values; Uncomment to check result …

  // IE 10
  // ua = 'Mozilla/5.0 (compatible; MSIE 10.0; Windows NT 6.2; Trident/6.0)';
  
  // IE 11
  // ua = 'Mozilla/5.0 (Windows NT 6.3; Trident/7.0; rv:11.0) like Gecko';
  
  // Edge 12 (Spartan)
  // ua = 'Mozilla/5.0 (Windows NT 10.0; WOW64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/39.0.2171.71 Safari/537.36 Edge/12.0';
  
  // Edge 13
  // ua = 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/46.0.2486.0 Safari/537.36 Edge/13.10586';

  var msie = ua.indexOf('MSIE ');
  if (msie > 0) {
    // IE 10 or older => return version number
    return parseInt(ua.substring(msie + 5, ua.indexOf('.', msie)), 10);
  }

  var trident = ua.indexOf('Trident/');
  if (trident > 0) {
    // IE 11 => return version number
    var rv = ua.indexOf('rv:');
    return parseInt(ua.substring(rv + 3, ua.indexOf('.', rv)), 10);
  }

  var edge = ua.indexOf('Edge/');
  if (edge > 0) {
    // Edge (IE 12+) => return version number
    return parseInt(ua.substring(edge + 5, ua.indexOf('.', edge)), 10);
  }

  // other browser
  return false;
}

var lastKnownResolution = [0, 0] ;


function openNext(element) {
	if (element.nextElementSibling.style.display != "block") {
		element.nextElementSibling.style.display = "block" ;
		element.classList.add("active")
	}
	else {
		element.nextElementSibling.style.display = "none" ;
		element.classList.remove("active")
	}
}

function getFileList() {
	var requestSender = new XMLHttpRequest() ;
	requestSender.open("GET", "/cgi-bin/listFiles?" + StorageLocation) ;
	requestSender.setRequestHeader("Content-Type", "video/mp4") ;

	requestSender.onreadystatechange = function(){ // do something with the response
		if (this.readyState == 4 && this.status == 200){
			parsedList = JSON.parse(requestSender.responseText) ;

			if ("totalFileCount" in parsedList) {
				document.getElementById("fileDownloadListInner").innerHTML = "";
				for (var i = 0 ; i < parsedList.totalFileCount ; i++) {
					var index = "file" + i ;
					var folderIndex = "folder" + i ;
					if (index in parsedList) {
						document.getElementById("fileDownloadListInner").innerHTML += '<a href="/cgi-bin/pleaseGiveMeAFile?location=' + StorageLocation + "&fileName=" + parsedList[index] + '">' + parsedList[index] + "</a>";
					}
					else if ( (folderIndex in parsedList ) && ("folderName" in parsedList[folderIndex]) ) {
						var folderElement = "" ;
						folderElement += '<a onclick="openNext(this)" class="innerDropDown">' + parsedList[folderIndex].folderName + '</a>' ;
						folderElement += '<div class="innerDropDownList">' ;
						if ("totalFileCount" in parsedList[folderIndex]) {
							for (var i2 = 0 ; i2 < parsedList[folderIndex].totalFileCount ; i2++ ) {
								var index2 = "file" + i2 ;
								if (index2 in parsedList[folderIndex]) {
									folderElement += '<a href="/cgi-bin/pleaseGiveMeAFile?location=' + StorageLocation ;
									folderElement += "&fileName=" + parsedList[folderIndex].folderName + "/" + parsedList[folderIndex][index2] + '" >' ;
									folderElement += parsedList[folderIndex][index2] + "</a>" ;
								}
							}
							if (parsedList[folderIndex].totalFileCount == 0)
								folderElement += '<a> >> No Downloadable Files </a>' ;
						}
						folderElement += '</div>' ;
						document.getElementById("fileDownloadListInner").innerHTML += folderElement ;
					}
				}
			}
			else
				document.getElementById("fileDownloadListInner").innerHTML = "<a> No Files Found</a>";

			document.getElementById("fileDownloadListInner").innerHTML += "<a onclick=\"getFileList()\"> Refresh File List </a>"
		}
	}

	if (StorageLocation != "") // only request if a storage location is set
		requestSender.send() ;
	else if (DebugOnOff)
		document.getElementById("debugger").innerHTML = " >> No storage location selected " ;
}


function boundInput(element) {
	if (parseInt(element.value) > parseInt(element.max))
		element.value = element.max ;
	else if (parseInt(element.value) < parseInt(element.min))
		element.value = element.min ;
}


var inputFunctions = {	"startMarker":		function(value){ document.getElementById("startFrameNum").value = value ; markerFill() ; setFrameLength() ; },
						"endMarker":		function(value){ document.getElementById("endFrameNum").value = value ; markerFill() ; setFrameLength() ; },

						"frameMarkStart":	function(){ document.getElementById("startMarker").value = document.getElementById("timeLine").value ; justRunSomething(document.getElementById("startMarker")) ; frameChange(document.getElementById("startMarker")) ; },
						"frameMarkEnd":		function(){ document.getElementById("endMarker").value = document.getElementById("timeLine").value ; justRunSomething(document.getElementById("endMarker")) ; frameChange(document.getElementById("endMarker")) ; },
						"frameStepB":		function(){ document.getElementById("timeLine").stepDown() ; sliderDragged(document.getElementById("timeLine")) ; },
						"frameStepF":		function(){ document.getElementById("timeLine").stepUp() ; sliderDragged(document.getElementById("timeLine")) ; },

						"overlayPlayModeButton": function() { dataRequester("startPlayback", '{"framerate": 0}', pageUpdate) ; },

						"currentFrameNum":	function(value){ boundInput(document.getElementById("currentFrameNum")) ; document.getElementById("timeLine").value = value ; sliderDragged(document.getElementById("timeLine")) ; },
						"startFrameNum":	function(value){ boundInput(document.getElementById("startFrameNum")) ; document.getElementById("startMarker").value = value ; markerFill() ; setFrameLength() ; },
						"endFrameNum":		function(value){ boundInput(document.getElementById("endFrameNum")) ; document.getElementById("endMarker").value = value ; markerFill() ; setFrameLength() ; },
						"frameLengthNum":	function(value){ setFrameLength() ; markerFill() ; },

						"overlayStopSaveButton": function() { dataSender("stopFilesave", "{}") ; },
					 }

function justRunSomething(element) {
	if (element.id in inputFunctions) // if the key-value exists
		inputFunctions[element.id](element.value) ; // run the function (with the value given)
}


function sliderDragged(element) {
	if (typeof sliderDragged.requestCount == 'undefined')
		sliderDragged.requestCount = 0 ;

	if (element.id == "timeLine" ) {

		var callWhenFinished = function(inputParams) { // set the callback / finished function
			pageUpdate(inputParams) ; // actually update the page
			sliderDragged.requestCount -= 1 ; // allow another request
		}
		if (sliderDragged.requestCount < 1) {
			sliderDragged.requestCount += 1 ;
			dataRequester("set", '{"playbackPosition": ' + element.value + '}', callWhenFinished) ; // set the current fram (playback position)
		}
	}
}

function setFrameLength() {
	var end = document.getElementById("endMarker") ;
	var start = document.getElementById("startMarker") ;
	var length = parseInt(end.value) - parseInt(start.value) ;
	if (length < 0)
		length = 0 ;
//	dataSender ("set", '{"playbackLength": ' + length + '}') ; // set the length

	if (document.getElementById("frameLengthNum") != document.activeElement) { // not focusing on frameLengthNum
		document.getElementById("frameLengthNum").value = length ;
	}
	else {
		element = document.getElementById("frameLengthNum") ;
		element.max = parseInt(end.max) - parseInt(start.value) ; // set the frameLength max
		boundInput(element) ; // force to between min and max
		end.value = parseInt(element.value) + parseInt(start.value) ; // set the end value
		boundInput(end) ; // keep the end value from being too high / too low
		document.getElementById("endFrameNum").value = end.value ; // copy the end frame value to the numeric display
	}
}


function markerFill() {
	var start = document.getElementById("startMarker") ;
	var end = document.getElementById("endMarker") ;

	start = parseFloat(start.value / start.max * 100) ;

	end = parseFloat(end.value / end.max * 100) ;

	if (start > end) {
		start = end ; // force to always have start <= end
		document.getElementById("startMarker").value = document.getElementById("endMarker").value ;
	}

	var fillBar = document.getElementById("startEndFill") ;

	fillBar.style.marginLeft = parseFloat(2 + start * 0.96) + "%" ;
	fillBar.style.width = parseFloat( (end - start) * 0.96 ) + "%" ;
}



function frameChange(element) {
	switch (element.id) {
		case "startMarker":
		case "startFrameNum":
			dataSender("set", '{"playbackStart": ' + element.value + '}') ;
			break ;

		case "endMarker":
		case "endFrameNum":
			dataSender ("set", '{"playbackLength": ' + document.getElementById("frameLengthNum").value + '}') ; // set the length
			break ;

		case "timeLine":
		case "currentFrameNum":
			dataRequester("set", '{"playbackPosition": ' + element.value + '}', pageUpdate) ; // set the current fram (playback position)
			break ;

		case "frameLengthNum":
			dataSender ("set", '{"playbackLength": ' + element.value + '}') ; // set the length
			break ;

	}
}

var StorageInfo ;

var StorageNames = { "sda1": "USB / SATA",
					 "mmcblk1p1": "SD Card"
				 }

var StorageLocation = "" ;


function saveVideo() {
	var fileName = document.getElementById("fileName").value ;

	if ( (StorageLocation != "") && (lastKnownFrameLength > 1) ) { // storage location set and some frames recorded
		var request = '{"device": "' + StorageLocation + '", "format": '
		switch (document.getElementById("saveFormat").firstChild.textContent) {
			case "CinemaDNG (raw)":
				request += '"dng"' ; // use cinemaDNG files
				break ;

			case "TIFF (images)":
				request += '"tiff"' ; // use tiff images
				break ;

			case "TIFF RAW (images)":
				request += '"tiffRaw"' ; // use tiff RAW images
				break ;

			case "H.264 (mp4)":
			default:
				request += '"h264"' ; // use h.264 format (mp4)
				break ;
		
		}

//		request += ', "start": ' + document.getElementById("startMarker").value ;
//		request += ', "length": ' + (parseInt(document.getElementById("endMarker").value) - parseInt(document.getElementById("startMarker").value)) ;

		request += ', "start": ' + lastKnownStartFrame ;
		request += ', "length": ' + parseInt(lastKnownFrameEnd - lastKnownStartFrame) ;

		var maxBitRate = document.getElementById("maxBitrateNum").value * 1000000 ;
		var bitRate = document.getElementById("bitsPerPixelNum").value ; // start with the bits per pixel

		if ( (lastKnownResolution[0] > 0) && (lastKnownResolution[1] > 0) ) {

			bitRate *= lastKnownResolution[0] * lastKnownResolution[1] ; // multiply by the resolution
			bitRate *= document.getElementById("saveFPSNum").value ; // multiply by the framerate

			if (maxBitRate < bitRate)
				bitRate = maxBitRate ; // correct to always be below the maximum

			request += ', "bitrate": ' + Math.floor(bitRate) ; // add the bitrate to the request
		}

		request += ', "framerate": ' + document.getElementById("saveFPSNum").value ; // add the framerate to te request

		if (fileName != "") // a file name was given
			request += ', "filename": "' + fileName + '"' ;

		request += '}' ; // finish off the request

		if (DebugOnOff)
			document.getElementById("debugger2").innerHTML = " ----- Here is the request: " + request ;

		dataSender ("startFilesave", request) ; // actually save the file
	}
	else { // could not save file
		if (DebugOnOff)
			document.getElementById("debugger2").innerHTML = " ---- Could not save video ---- " ;

		if (StorageLocation == "")
			document.getElementById("errorWhileSavingBox").firstChild.textContent = "Cannot save video. Please select a storage device." ;
		else
			document.getElementById("errorWhileSavingBox").firstChild.textContent = "Nothing to save. Please record something first." ;

		document.getElementById("popUpBackground").classList.remove("hidden") ;
		document.getElementById("errorWhileSavingBox").classList.remove("hidden") ; // show the reason why you're unable to save
	}
}



function useStorageLocation(key) {
	if (key in StorageInfo) {
		var temp = "" ;		 
		if (key in StorageNames)
			temp += StorageNames[key] ; // write a more readable name
		temp += "   (" + key + ")" ; // write the system name/location

		document.getElementById("storageLocation").firstChild.textContent = temp ; // write the selected storage location to the 'storage location' drop-down

		var saveStorageVal = parseInt(getCookie("as")) ;

		var i = 0 ;
		for (i = 0 ; i < Object.keys(StorageNames).length ; i++) {
			if (Object.keys(StorageNames)[i] == key) {
				if ( (saveStorageVal < 1) || isNaN(saveStorageVal) )
					setCookie("as", parseInt((i + 1) * -1)) ; // save this as the auto-select device
				else
					setCookie("as", parseInt(i + 1)) ; // save this as the auto-save device
			}
		}

		var requestSender = new XMLHttpRequest() ; // set up a new request
		requestSender.open("get", "/cgi-bin/storageInfo?" + key) ; // call my 'storageInfo' script
		requestSender.setRequestHeader("Content-Type", "application/json") ; // use json format

		requestSender.onreadystatechange = function(){ // do something with the response
			if (this.readyState == 4 && this.status == 200){ // wait for successful response
				var jsonBack = JSON.parse(requestSender.responseText) ; // convert to json
				if ("size" in jsonBack) // display the total storage space
					document.getElementById("storageSize").innerHTML = (jsonBack.size / 1000000).toFixed(1) + " GB" ;
				if ("available" in jsonBack) // display the available space
					document.getElementById("storageAvailable").innerHTML = (jsonBack.available / 1000000).toFixed(1) + " GB" ;
				if ("used" in jsonBack) // display the used space
					document.getElementById("storageUsed").innerHTML = (jsonBack.used / 1000000).toFixed(1) + " GB" ;
				if ("usedPercent" in jsonBack) // show the usage percent as a bar-graph
					document.getElementById("storageBar").firstChild.style.width = jsonBack.usedPercent + "%" ;
			}
		}

		requestSender.send() ; // ask the camera for storage size info


		StorageLocation = key ; // save the storage location

		document.getElementById("saveVideoButton").classList.remove("disabled") ; // enable the save button

		getFileList() ; // populate the "download from camera" dropdown with files to download
	}
	else {
		document.getElementById("storageSize").innerHTML = "" ;
		document.getElementById("storageAvailable").innerHTML = "" ;
		document.getElementById("storageUsed").innerHTML = "" ;

		StorageLocation = "" ; // save the storage location

		document.getElementById("saveVideoButton").classList.add("disabled") ; // disable the save button
	}
}


var VideoOutlineStyle = document.getElementById("videoDisplay").style.border ; // get the style of the border

function theme(selection) { // set a new stylesheet to use

	if ( (selection == "default") || (selection == "monochrome") || (selection == "darker") || (selection == "lighter") || (selection == "monoDark") || (selection == "newDefault") ) {
		document.getElementById("themeSelection").href = "/css/" + selection + "Theme.css" ;

		VideoOutlineStyle = document.getElementById("videoDisplay").style.border ; // get the style of the border

	}
}



var dropDownFunctions = { "Refresh":		function(){ dataGetter("get", 'externalStorage', pageUpdate); },

						"H.264 (mp4)":	function(){ document.getElementById("saveFormat").firstChild.textContent = "H.264 (mp4)"; setCookie("ff", 0) ; },
						"CinemaDNG (raw)": function(){ document.getElementById("saveFormat").firstChild.textContent = "CinemaDNG (raw)"; setCookie("ff", 1) ; },
						"TIFF (images)":	function(){ document.getElementById("saveFormat").firstChild.textContent = "TIFF (images)"; setCookie("ff", 2) ; },
						"TIFF RAW (images)": function(){ document.getElementById("saveFormat").firstChild.textContent = "TIFF RAW (images)"; setCookie("ff", 3) ; },

						"Debug Tools":	function(){ var item = document.getElementById("debugBar") ; if (item.classList.contains("hidden")) { item.classList.remove("hidden") ; } else { item.classList.add("hidden") ; } },
						"Play Mode":		function() { dataRequester("startPlayback", '{"framerate": 0}', pageUpdate) ; },
						"Record Mode":	function() { dataRequester("startLivedisplay", "{}", pageUpdate) ; },
						  
						"Update":		function() { dataGetter("p", "", pageUpdate) ; },

						"Ok":				function() { document.getElementById("popUpBackground").classList.add("hidden") ; document.getElementById("errorWhileSavingBox").classList.add("hidden") ; },
						}


function dropDownSelect (element) {
	if (element.innerText in dropDownFunctions) // if the key-value exists
		dropDownFunctions[element.innerText]() ; // run the function
}

if (!Element.prototype.matches) {
  Element.prototype.matches = Element.prototype.msMatchesSelector;
}

window.onclick = function(event) { // check where a click was: if it was outside a menu, close that menu
	if ( !event.target.matches(".menuClickOk") && (event.target.parent == undefined || !event.target.parent.matches(".menuClickOk"))
	&& (document.getElementById("menu").matches(".active")) ) {
		toggler(document.getElementById("menu")) ; // toggle off the button (and close the menu)
	}
}



var img = document.getElementById("imageDisplay") ;

var videoWindow = document.getElementById("videoDisplay");

img.onload = function scaleToFit(){
	videoWindow.style.height = "650px" ;

	var scale = Math.min(videoWindow.clientWidth / img.width, videoWindow.clientHeight / img.height) ;
	var x = (videoWindow.clientWidth / 2) - (img.width / 2) * scale;
	var y = (videoWindow.clientHeight / 2) - (img.height / 2) * scale;
	img.height = img.height * scale ;
	if (img.height < videoWindow.clientHeight) { // image height is less than window height
		videoWindow.style.height = (img.height + 6).toString() + "px";
	}
}

document.getElementById("menu").onmouseenter = function(){ document.getElementById("menuList").style.display = "block" ; }
document.getElementById("menu").onmouseleave = function() {
	var otherMenu = document.getElementById("menuList") ;
	setTimeout( function() {
		if (!document.getElementById("menu").classList.contains("active"))
			document.getElementById("menuList").style.display = "" ;
	}, 50) ;
}

					//	 key	 	 inactive		active
var nameChange = 	{	"playButton": 	["<div class='playIcon'></div>&ensp;Play", "<div class='pauseIcon'></div>&ensp;Pause"],
						"textOverlayButton": ["Off", "On"],
					}

var buttonFunctions = {	"playButton":	[ function(){ dataRequester("startPlayback", '{"framerate": 0}', pageUpdate) ; }, function(){ dataRequester("startPlayback", '{"framerate": ' + document.getElementById("playBackRateNum").value + ', "position": ' + document.getElementById("currentFrameNum").value + '}', pageUpdate) ;} ],
						"menu":			[ function(){ document.getElementById("menuList").style.display = "" ; }, function(){ menuKeeper() ; document.getElementById("menuList").style.display = "block" ;} ],
						"textOverlayButton":	[ function(){ dataSender("set", '{"overlayEnable": false}') ; }, function(){ dataSender("set", '{"overlayEnable": true}') ; } ],
						"debugToggle":	[ function(){ DebugOnOff = false ; document.getElementById("debugger").innerHTML = "" ; document.getElementById("debugger2").innerHTML = "" ; }, function() { DebugOnOff = true ; } ],
					  }


function toggler(element) { // toggle the class (active/inactive), change the name, and run a function for a toggle button/switch
	var leftRight = 0 ;

	if (element.classList.contains("active")) { // changing to 'inactive' or no state set previously
		element.classList.remove("active") ; // remove the "active" styling
		element.classList.add("inactive") ; // use the "inactive" styling
		leftRight = 0 ; // use the 'left' column for names / functions
	}
	else if (element.classList.contains("disabled")) { // button disabled
		return ; // don't do anything
	}
	else {
		element.classList.remove("inactive") ; // remove the "inactive" styling
		element.classList.add("active") ; // use the "active" styling
		leftRight = 1 ; // use the 'right' column for names / functions
	}

	if (element.id in nameChange) // check if key-value exists
		element.innerHTML = nameChange[element.id][leftRight] ; // set name to the left (inactive) or right (active) one

	if (element.id in buttonFunctions) // if the key-value exists
		buttonFunctions[element.id][leftRight]() ; // run the left (inactive) or right (active) function
}

function stateSelecter(element, state) { // this is like toggler above, but doesn't run the function ; set the class (active/inactive), change the name

	if (state) { // switch to active
		element.classList.remove("inactive") ; // remove the "inactive" styling
		element.classList.add("active") ; // use the "active" styling
	}
	else { // switch to inactive
		element.classList.remove("active") ; // remove the "active" styling
		element.classList.add("inactive") ; // use the "inactive" styling
	}

	if (element.id in nameChange) // check if key-value exists
		element.innerHTML = nameChange[element.id][state] ; // set name to the left (inactive) or right (active) one
}


function menuKeeper() {
	document.getElementById("menu").classList.remove("inactive");
	document.getElementById("menu").classList.add("active");
}


function batteryPercent(level, charging) { // set the percentage (level) of the battery (and whether it's charging)
	var indicator = document.getElementById("battery-level") ;
	var text = document.getElementById("battery%") ;

	if (level <= 100 && level >= 0) { // not charging (and level is ok)
		text.innerHTML = level.toString() + "%" ;


		if (charging) {
			indicator.style.height = "100%" ; // just make the level full when charging
			indicator.style.backgroundColor = "white" ; // white background while charging
			indicator.innerHTML = '<div id="chargeIcon" class="hidden"></div>' ; // add the charging indicator
		}
		else {
			indicator.style.height = level.toString() + "%" ;
			indicator.innerHTML = '' ; // clear the charging icon

			if (level <= 20)
				indicator.style.backgroundColor = "#a00" ; // red (low)
			else if (level <= 55)
				indicator.style.backgroundColor = "#e7ba00" ; // yellow (less than half)
			else
				indicator.style.backgroundColor = "green" ; // green (fine / more than half)
		}
	}
}


var lastKnownBatteryLevel = 0 ;
var lastKnownExternalPower = false ;

var lastKnownVideoState = "live" ;
var lastKnownFrameEnd = 1 ;
var lastKnownCurrentFrame = 0 ;
var lastKnownStartFrame = 0 ;
var lastKnownFrameLength = 1 ;
var lastKnownState = "idle" ;


function pageUpdate(rawData){
	var parsedData = JSON.parse(rawData) ;

	if (DebugOnOff)
		document.getElementById("debugger").innerHTML += "<br><br>got info:" + rawData;

	if (parsedData.state == "idle") { // idle (ready to record)
		videoWindow.style.border = VideoOutlineStyle ; // set the idle outline colour

		if ( (getCookie("as") > 0) && (getCookie("sr") == 1) && (lastKnownState == "recording") ) // auto-save enabled and video has not already been saved, and just finished recording
			saveWholeVideo() ; // Auto-save the video

		lastKnownState = parsedData.state ; // store previous camera state
	}
	else if (parsedData.state == "recording") { // recording
		videoWindow.style.border = "3px solid #a00" ; // set the recording outline colour
		setCookie("sr", 1) ; // new data is being recorded that has not been saved yet

		lastKnownState = parsedData.state ; // store previous camera state
	}
	else if (parsedData.state == "blackcal") { // doing a calibration
		videoWindow.style.border = "3px dashed white"; // set the blackCal outline color

		lastKnownState = parsedData.state ; // store previous camera state
	}


	if ("batteryChargePercent" in parsedData) {
		lastKnownBatteryLevel = Math.round(parsedData.batteryChargePercent) ; // set the last known battery percent value
		batteryPercent(lastKnownBatteryLevel, lastKnownExternalPower) ; // update the battery indicator
	}

	if ("externalPower" in parsedData) {
		lastKnownExternalPower = parsedData.externalPower ; // set the last known power connection
		batteryPercent(lastKnownBatteryLevel, lastKnownExternalPower) ; // update the battery indicator
	}




	if ("externalStorage" in parsedData) { // get and build a list of external storage devices on the camera
		StorageInfo = parsedData.externalStorage ; // set up or change the "StorageInfo" variable
		StorageInfo.size = -1 ; // start the size at -1 because it will count the "size" key in the next step

		for (key in StorageInfo)
			StorageInfo.size++ ; // count the number of keys in the object


		var list = document.getElementById("storageLocationInner") ; // get the storage location drop-down list element

		if (StorageInfo.size > 0) { // are there devices connected?
			list.innerHTML = "" ; // clear the list before (re)populating the list
			for (key in StorageInfo) { // build the list of storage locations
				if (key != "size") {
					var temp = '<a onclick=\'useStorageLocation("' + key + '")\'>' ; // start the line
					if (key in StorageNames)
						temp += StorageNames[key] ; // add a more readable name
					temp += '&ensp;(' + key + ')</a>' ; // finish the line

					list.innerHTML += temp ; // add the line to the list
				}
			}

			var saveStorageVal = parseInt(getCookie("as")) ; // check if a storage device has already been selected as a default

			if ( (saveStorageVal != 0) && !isNaN(saveStorageVal) ) { // if a storage device has been selected
				if (saveStorageVal < 0)
					saveStorageVal *= -1 ; // get absolute value

				key = Object.keys(StorageNames)[saveStorageVal - 1] ; // get the key value (one less than the saved number)

				if (key in StorageInfo) // if the storage device has been added
					useStorageLocation(key) ; // use this storage device
			}

		}
		else { // no devices connected
			document.getElementById("storageLocation").firstChild.textContent = "Location" ; // set the drop-down to say 'Location'
			list.innerHTML = '<a>No Storage Connected</a>' ; // just have the drop-down say that nothing's connected

			document.getElementById("storageSize").innerHTML = "" ; // clear the 'Size' parameter
			document.getElementById("storageAvailable").innerHTML = "" ; // clear the 'Available' parameter
			document.getElementById("storageUsed").innerHTML = "" ; // clear the 'Used' parameter

			document.getElementById("saveVideoButton").classList.add("disabled") ;
		}
		list.innerHTML += '<a onclick="dropDownSelect(this)">Refresh</a>' ; // add a 'refresh' option to the list
	}

	if ("videoState" in parsedData) { // got the current videoState
		switch (parsedData.videoState) {
			case "live":
				document.getElementById("saveProgress").classList.remove("hidden") ;
				document.getElementById("videoStateOverlay").innerHTML = "Live Display" ;
				document.getElementById("saveProgressFill").style.width = 0 ;
				document.getElementById("saveProgress").lastChild.textContent = "Recording or ready to record" ;
				document.getElementById("timelineHolder").classList.add("hidden") ;

				stateSelecter(document.getElementById("playButton"), 0) ;
				document.getElementById("playButton").classList.remove("disabled") ;

				document.getElementById("overlayButtons").innerHTML = '<a id="overlayNavigateButton" href="/">Record Screen</a><a id="overlayPlayModeButton" onclick="justRunSomething(this)">Play Mode</a>'
				break ;

			case "play":
				document.getElementById("saveProgress").classList.add("hidden") ;
				document.getElementById("timelineHolder").classList.remove("hidden") ;
				document.getElementById("videoStateOverlay").innerHTML = "Playing Video" ;

				if ("framerate" in parsedData) {
					if (parsedData.framerate == 0)
						stateSelecter(document.getElementById("playButton"), 0) ;
					else {
						stateSelecter(document.getElementById("playButton"), 1) ;
						document.getElementById("playBackRateNum").value = parsedData.frameRate ;
					}
				}
				document.getElementById("playButton").classList.remove("disabled") ;
				break ;

			case "filesave":
				if (lastKnownVideoState != "filesave")
					document.getElementById("saveProgressFill").style.width = 0 ;
				document.getElementById("saveProgress").classList.remove("hidden") ; // show the progress bar
				document.getElementById("videoStateOverlay").innerHTML = "Saving Video" ;
				document.getElementById("timelineHolder").classList.add("hidden") ;

				document.getElementById("playButton").classList.add("disabled") ;
				stateSelecter(document.getElementById("playButton"), 0) ;

				document.getElementById("overlayButtons").innerHTML = '<a id="overlayStopSaveButton" onclick="justRunSomething(this)">Cancel Save</a>'

				setCookie("sr", 0) ; // saved the video (don't need to warn next time I record)
				break ;
		}
		lastKnownVideoState = parsedData.videoState ; // set the last known video state
	}
	else if ("liverecord" in parsedData) { // response from a video state change
		if ( ("filesave" in parsedData) && (parsedData.filesave == true) ) {
			document.getElementById("saveProgressFill").style.width = 0 ;
			document.getElementById("saveProgress").classList.remove("hidden") ; // show the progress bar
			document.getElementById("videoStateOverlay").innerHTML = "Saving Video" ;
			document.getElementById("timelineHolder").classList.remove("hidden") ;

			document.getElementById("playButton").classList.add("disabled") ;
			stateSelecter(document.getElementById("playButton"), 0) ;
			lastKnownVideoState = "filesave" ;
			setCookie("sr", 0) ; // saved the video (don't need to warn next time I record)
		}

		if ( ("playback" in parsedData) && (parsedData.playback == true) ) {
			document.getElementById("saveProgress").classList.add("hidden") ;
			document.getElementById("timelineHolder").classList.remove("hidden") ;
			document.getElementById("videoStateOverlay").innerHTML = "Playing Video" ;

			if ("framerate" in parsedData) {
				if (parsedData.framerate == 0)
					stateSelecter(document.getElementById("playButton"), 0) ;
				else
					stateSelecter(document.getElementById("playButton"), 1) ;
			}
			document.getElementById("playButton").classList.remove("disabled") ;
			lastKnownVideoState = "play" ;
		}

		if (parsedData.liverecord == true) {
			document.getElementById("saveProgress").classList.remove("hidden") ;
			document.getElementById("videoStateOverlay").innerHTML = "Live Display" ;
			document.getElementById("saveProgressFill").style.width = 0 ;
			document.getElementById("saveProgress").lastChild.textContent = "Recording or ready to record" ;
			document.getElementById("timelineHolder").classList.add("hidden") ;

			stateSelecter(document.getElementById("playButton"), 0) ;
			document.getElementById("playButton").classList.remove("disabled") ;
			lastKnownVideoState = "live" ;
		}

		if ("framerate" in parsedData) {
		}

		if ("totalSegments" in parsedData) {
		}

		if ("segment" in parsedData) {
		}
	}

	if ("totalFrames" in parsedData) {
		lastKnownFrameLength = parsedData.totalFrames ; // set the last known end frame to the total frames recorded
		document.getElementById("startMarker").max = parsedData.totalFrames ;
		document.getElementById("endMarker").max = parsedData.totalFrames ;
		document.getElementById("timeLine").max = parsedData.totalFrames ;
		markerFill() ; // update the highlighted area above the timeline

		document.getElementById("totalFramesNum").innerHTML = parsedData.totalFrames ; // update the total frame number display
		document.getElementById("currentFrameNum").max = parsedData.totalFrames ;
		document.getElementById("startFrameNum").max = parsedData.totalFrames ;
		document.getElementById("endFrameNum").max = parsedData.totalFrames ;
		document.getElementById("frameLengthNum").max = parsedData.totalFrames ;
	}

	if ("playbackStart" in parsedData) {
		lastKnownStartFrame = parsedData.playbackStart ; // set the last known playback starting point
		if (document.getElementById("startMarker") != document.activeElement)
			document.getElementById("startMarker").value = parsedData.playbackStart ; // set the slider position

		if (document.getElementById("startFrameNum") != document.activeElement)
			document.getElementById("startFrameNum").value = parsedData.playbackStart ;

		if ("totalFrames" in parsedData)
			document.getElementById("frameLengthNum").max = parsedData.totalFrames - parsedData.playbackStart ;
	}

	if ("playbackLength" in parsedData) {
		lastKnownFrameEnd = parseInt(parsedData.playbackLength + parseInt(document.getElementById("startMarker").value)) ; // set the last known playback length
		if (document.getElementById("endMarker") != document.activeElement)
			document.getElementById("endMarker").value = parseInt(parsedData.playbackLength) + parseInt(document.getElementById("startMarker").value) ;
		markerFill() ; // update the highlighted area above the timeline

		if (document.getElementById("frameLengthNum") != document.activeElement)
			document.getElementById("frameLengthNum").value = parsedData.playbackLength ;

		document.getElementById("frameLengthNum").max = document.getElementById("totalFramesNum").value - document.getElementById("startFrameNum").value ;

		if (document.getElementById("endFrameNum") != document.activeElement)
			document.getElementById("endFrameNum").value = document.getElementById("endMarker").value ;
	}

	if ("playbackPosition" in parsedData) { // get the playback frame
		if (lastKnownVideoState == "filesave") {
			// display a progress bar here
			var progress = parseFloat(parsedData.playbackPosition - lastKnownStartFrame) / parseFloat(lastKnownFrameEnd - lastKnownStartFrame) * 100 ;
			if (progress > 99.9)
				progress = 99.9 ;
			if (parseFloat(progress) > parseFloat(document.getElementById("saveProgressFill").style.width)) { // only go up with the percentage
				document.getElementById("saveProgress").lastChild.textContent = progress.toFixed(1) + "% --  frame " + parsedData.playbackPosition + " of " + lastKnownFrameEnd ;
				document.getElementById("saveProgressFill").style.width = progress + "%" ;
			}
		}
		else if (lastKnownVideoState == "play") {
			var timeLine = document.getElementById("timeLine") ;
			if (timeLine != document.activeElement)
				timeLine.value = parsedData.playbackPosition ; // don't update the timeline if I'm dragging it
			var currentFrameNum = document.getElementById("currentFrameNum") ;
			if (currentFrameNum != document.activeElement)
				currentFrameNum.value = parsedData.playbackPosition ;
		}
		lastKnownCurrentFrame = parsedData.playbackPosition ;
	}
	else if ("position" in parsedData) {
		if (lastKnownVideoState == "filesave") {
			var progress = parseFloat(parsedData.position - lastKnownStartFrame) / parseFloat(lastKnownFrameEnd - lastKnownStartFrame) * 100 ;
			if (parseFloat(progress) > parseFloat(document.getElementById("saveProgressFill").style.width)) {
				document.getElementById("saveProgress").lastChild.textContent = progress.toFixed(1) + "% --  frame: " + parsedData.position + " of: " + lastKnownFrameEnd ;
				document.getElementById("saveProgressFill").style.width = progress + "%" ;
			}
		}
		else if (lastKnownVideoState == "play") {
			var timeLine = document.getElementById("timeLine") ;
			if (timeLine != document.activeElement)
				timeLine.value = parsedData.position ;
			var currentFrameNum = document.getElementById("currentFrameNum") ;
			if (currentFrameNum != document.activeElement)
				currentFrameNum.value = parsedData.position ;
		}
		lastKnownCurrentFrame = parsedData.position ;
	}

	if ("playbackRate" in parsedData) {
		if (parsedData.playbackRate == 0)
			stateSelecter(document.getElementById("playButton"), 0) ;
		else {
			stateSelecter(document.getElementById("playButton"), 1) ;
			document.getElementById("playBackRateNum").value = parsedData.playbackRate ;
		}
	}

	if ("resolution" in parsedData) {
		if ("hRes" in parsedData.resolution)
			lastKnownResolution[0] = parsedData.resolution.hRes ;
		if ("vRes" in parsedData.resolution)
			lastKnownResolution[1] = parsedData.resolution.vRes ;
	}

	if ("overlayEnable" in parsedData) {
		if (parsedData.overlayEnable)
			stateSelecter(document.getElementById("textOverlayButton"), 1) ;
		else
			stateSelecter(document.getElementById("textOverlayButton"), 0) ;
	}

}


function dataRequester(method, parameter, callMeMaybe) {
	var requestSender = new XMLHttpRequest() ; // set up a new request
	requestSender.open("POST", "/control/" + method) ; // use "post", and use the /control/ method
	requestSender.setRequestHeader("Content-Type", "application/json") ; // use json format

	requestSender.onreadystatechange = function(){ // do something with the response
		if (this.readyState == 4 && this.status == 200){ // wait for successful response
			callMeMaybe(requestSender.responseText) ; // call the callback function with the response text
		}
	}

	requestSender.send(parameter) ;
}


function dataSender(method, parameter){
	var requestSender = new XMLHttpRequest() ;
	requestSender.open("POST", "/control/" + method) ;
	requestSender.setRequestHeader("Content-Type", "application/json") ;

	requestSender.send(parameter) ;
}

function dataGetter(method, parameter, callMeMaybe){
	var requestSender = new XMLHttpRequest() ;
	requestSender.open("GET", "/control/" + method + ( (parameter !== "") ? "?" + parameter : "")) ;
	requestSender.setRequestHeader("Content-Type", "application/json") ;

	requestSender.onreadystatechange = function(){ // do something with the response
		if (this.readyState == 4 && this.status == 200){
			callMeMaybe(requestSender.responseText) ; // call this function to deal with the input and update the page
			 // callback function, passing in the string we got back
		}
	}

	requestSender.send(parameter) ;
}

var useServerSentEvents = true;

if (typeof(EventSource) != "undefined") {
	const evtSource = new EventSource("/control/subscribe");

	evtSource.onmessage = function(event) {
		if (DebugOnOff)
			document.getElementById("debugger").innerHTML = "onmessage:" + event.data;
	}
	evtSource.addEventListener("notify", function(event) {pageUpdate(event.data);}, false);
	evtSource.addEventListener("complete", function(event) { pageUpdate(event.data) ; if (DebugOnOff) document.getElementById("debugger").innerHTML = "got complete:" + event.data; }, false);
}
else {
	useServerSentEvents = false;
	document.getElementById("refreshAllBox").classList.remove("hidden") ;
}

dataGetter("p", "", pageUpdate) ; // get all the data on startup




var PollCounter = 1 ;
function pollOnlyUpdates() { // some information I can only get if I ask for it, so that's what I do here

	if (PollCounter % 2 == 0) { // every 1 second
		if (lastKnownVideoState != "filesave")
			img.src = "/cgi-bin/screenCap?" + Math.random() ; // ask for an updated image

		dataGetter('get', 'playbackPosition', pageUpdate) ; // ask for the current position while a file is being saved
	}

	if (PollCounter % 30 == 0) { // every 15 seconds
		dataGetter('get', 'batteryChargePercent', pageUpdate) ; // ask for the battery charge level
	}

	if (PollCounter % 120 == 0) { // every 60 seconds
		dataGetter('get', 'externalStorage', pageUpdate) ; // ask for the external storage devices
	}


	if (!useServerSentEvents) { // no server-sent events; ask for updates
		if (PollCounter % 3 == 0)
			dataGetter('get', 'state', pageUpdate) ; // check for a change in state

		if (PollCounter % 5 == 0) {
			dataGetter('get', 'videoState', pageUpdate) ; // check for video state changes
		}

		if (PollCounter % 31 == 0)
			dataGetter('get', 'externalPower', pageUpdate) ; // check for external power connection

	}


	PollCounter++ ;
}

switch (getCookie("ff")) { // get the save file format
	case "": // no cookie set yet; ignore - if a file is saved, it will just default to H264 (mp4)
		break ;
	case "0": // H264 (mp4)
		document.getElementById("saveFormat").firstChild.textContent = "H.264 (mp4)";
		break ;
	case "1": // DNG (raw)
		document.getElementById("saveFormat").firstChild.textContent = "CinemaDNG (raw)";
		break ;
	case "2": // TIFF 12-bit
		document.getElementById("saveFormat").firstChild.textContent = "TIFF (images)";
		break ;
	case "3": // TIFF 16-bit
		document.getElementById("saveFormat").firstChild.textContent = "TIFF RAW (images)";
		break ;
}

var intervalID = setInterval(pollOnlyUpdates, 500) ; // poll the camera for things that are not reported





</script>
</html>


