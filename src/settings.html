<!DOCTYPE html>
<html><head>
<meta name="viewport" content="width=device-width, initial-scale=1" charset="utf-8"/>
<title>Chronos</title>


<link rel="stylesheet" href="css/fontFile.css"> 

<link rel="styleSheet" href="css/sizeAndSpacing.css">
<link id="themeSelection" rel="styleSheet" href="css/defaultTheme.css">
<link id="windozeFixer" rel="styleSheet" href="">

<style>


.infoText {
	display: inline-block;
	margin-right: 100px;
}

/******** Specific to this page ********/


/*@media screen and (max-width: 3000px) {
	.leftContainer, .rightContainer { box-shadow: 0 0 3px 3px inset white; }
} */


@media screen and (min-width: 1600px) {
	.leftContainer, .rightContainer { max-width: 785px; }
	#container1 { margin-bottom: 6px; }
}

@media screen and (max-width: 1600px) {
	.leftContainer, .rightContainer { max-width: 680px; }
	#container2 { margin-bottom: 6px; }
}

@media screen and (max-width: 1400px) {
	.leftContainer, .rightContainer { max-width: 785px; }
}
@media screen and (max-width: 800px) {
	.leftContainer, .rightContainer { max-width: 100%; }
}




@media screen and (max-width: 1142px) { /* change formatting when screen size is narrower than this */
	#settings { display: none; } /* hide the settings button */
}

@media screen and (max-width: 980px) { /* change formatting when screen size is narrower than this */
	#help { display: none; } /* hide the help button */

	body { margin: 0; }
}

@media screen and (max-width: 705px) { /* change formatting when screen size is narrower than this */
	#ioNav { display: none; } /* hide the IO config button */

	.subTitle { display: none; }

}

/*@media screen and (max-width: 743px) {
	#saveAsBox { clear: left; }
} */

@media screen and (max-width: 542px) { /* change formatting when screen size is narrower than this */
	#playSave { display: none; } /* hide the PlaySave button */


	.infoText { margin-right: 0px; }
}

@media screen and (max-width: 455px) { /* change formatting when screen size is narrower than this */
	.titleImage img { width: 100%; height: auto; }
}

@media screen and (max-width: 365px) { /* change formatting when screen size is narrower than this */
	#main { display: none; } /* hide the main button */
	#menu { width: 90%; }
}



#colMatrixa, #colMatrixd, #colMatrixg, #colourPreset1Btn, #colourPreset2Btn, #colourIdentityBtn,
#whiteBalNuma, #autoSaveButton {
	margin-left: 0;
}

#colourApplyBtn { float: right; }

#resetAll {
	float: right;
	width: 235px;
}

#changeModeBox { max-width: 285px; }
#autoSaveBox {
	max-width: 220px;
	padding-bottom: 14px;
}
#camDisplayBox {
	padding-bottom: 14px;
}

#colourMatrixBox { clear: left; }


#refreshAllBox { max-width: 278px; }
#refreshButton { float: right; }


#defaultTrigDelay { float: right; }


#focusPeakingColorDropdown a:hover {
	font-weight: bold;
}

#autoPowerDropdown, #recordModeDropdown { margin-bottom: 0; }
#focusPeakingColorDropdown { margin-bottom: 2px; }

#recordModeBox, #focusPeakingBox {
	padding-left: 9px;
	padding-right: 9px;
}

#autoPowerBox {
	padding-top: 7px;
	padding-bottom: 9px;
}

#postTriggerTime { margin-bottom: 12px; }

.disabled {
	color: white;
	background-color: #222;
	text-decoration: line-through; /* cross out the apply button */
}
.wrapAround { clear: left; }

</style>
</head>


<body onclick="">

	<div class="header">
		<div class="titleImage">
			<img id="logoImage" src="Chronos High Speed logo.png">
		</div>

		<div class="subTitle">by <a href="https://www.krontech.ca" target="_blank">Kron Technologies</a></div>
	</div>

 <div class="mainContainer"> 

	
	<div class="heading-bar">
		<a id="main" href="./"> <div class="homeIcon"></div> Main </a>
		<a id="playSave" href="PlaySave.html"> <div class="playIcon"></div> Play & Save </a>
		<a id="settings" class="active"> <div class="settingsIcon"></div> Settings </a>
		<a id="ioNav" href="IO.html"> <div class="ioIcon"></div> I/O Config </a>
		<a id="help" href="/apidoc/"> <div class="helpIcon">?</div> Documentation </a>

		<a id="menu" onclick="toggler(this)" class="menuClickOk"> <div class="menuIcon"></div> Menu </a>
		<div id="menuList" onmouseover="menuKeeper()" class="menuContainer menuClickOk">
			<a href="/"> Record (Main) </a>
			<a href="PlaySave.html"> Play & Save </a>
			<a href="settings.html"> Camera Settings </a>
			<a href="IO.html"> I/O Configuration </a>
			<a href="/apidoc/"> Documentation </a>
			<a onclick="dropDownSelect(this)">Play Mode</a>
			<a onclick="dropDownSelect(this)">Record Mode</a>
<!--
			<a onclick="dropDownSelect(this)">Debug Tools</a>
-->
		</div>

	</div>


	<div id="container1" class="rightContainer">

		<div id="changeModeBox" class="horizLayout">
			<b> Change Camera Mode </b>
			<br>
			<span class="instruction"> Select when to change the camera into live/record mode or play/save mode (Webpage Only) </span>
			<br>
			<div id="changeModeDropdown" class="selectContainerHolder" onclick=""> Manually <div class="selectContainer">
				<a onclick="dropDownSelect(this)">Manually</a>
				<a onclick="dropDownSelect(this)">On Navigate</a>
			</div></div>
		</div>


		<div id="autoSaveBox" class="horizLayout">
			<b> Auto Save </b>
			<br>
			<span class="instruction"> Save the entire recording automatically after finishing a recording </span>
			<br>
			<a id="autoSaveButton" class="button" onclick="toggler(this)">No</a>
			<span class="instruction"> (Webpage Only)</span>
		</div>


		<div class="horizLayout">
			<b> Notify Before Recording </b>
			<br>
			<span class="instruction"> Ask before discarding unsaved video in RAM </span>
			<br>
			<div id="recordWarn" class="selectContainerHolder" onclick="">If Unsaved<div class="selectContainer">
				<a onclick="dropDownSelect(this)">Always</a>
				<a onclick="dropDownSelect(this)">If Unsaved</a>
				<a onclick="dropDownSelect(this)">Never</a>
			</div></div>
			<span class="instruction"> (Webpage Only) </span>
		</div>


		<div class="horizLayout">
			<b> Webpage Theme </b>
			<br>
			<span class="instruction">Select webpage colors</span>
			<br>
			<div id="themeSelector" class="selectContainerHolder" onclick="">Webpage Theme<div class="selectContainer">
				<a onclick='theme("default")'> Default </a>
				<a onclick='theme("monochrome")'> Monochrome </a>
				<a onclick='theme("darker")'> Dark </a>
				<a onclick='theme("newDefault")'> Light </a>
				<a onclick='theme("monoDark")'> Mono Dark </a>
				<a onclick='theme("lighter")'> Light 2 </a>
			</div></div>
		</div>


		<div id="colourMatrixBox" class="horizLayout">
			<b> Color Matrix </b>
			<br>
				<input id="colMatrixa" type="number" min="-5.0" max="5.0" step="0.0001"><input id="colMatrixb" type="number" min="-5.0" max="5.0" step="0.0001"><input id="colMatrixc" type="number" min="-5.0" max="5.0" step="0.0001">
				<br>
				<input id="colMatrixd" type="number" min="-5.0" max="5.0" step="0.0001"><input id="colMatrixe" type="number" min="-5.0" max="5.0" step="0.0001"><input id="colMatrixf" type="number" min="-5.0" max="5.0" step="0.0001">
				<br>
				<input id="colMatrixg" type="number" min="-5.0" max="5.0" step="0.0001"><input id="colMatrixh" type="number" min="-5.0" max="5.0" step="0.0001"><input id="colMatrixi" type="number" min="-5.0" max="5.0" step="0.0001">
				<br>
				<a id="colourPreset1Btn" class="button" onclick="justRunSomething(this)">CIECAM16</a>
				<span class="instruction"> (Default)</span>
				<br>
				<a id="colourPreset2Btn" class="button" onclick="justRunSomething(this)">CIECAM02</a>
				<br>
				<a id="colourIdentityBtn" class="button" onclick="justRunSomething(this)">Identity</a>
				<a id="colourApplyBtn" class="button" onclick="justRunSomething(this)">Apply</a>
		</div>


		<div id="whiteBalanceBox" class="horizLayout">
			<b> Custom White Balance </b>
			<br>
			<input id="whiteBalNuma" type="number" min="-5.0" max="5.0" step="0.0001"><input id="whiteBalNumb" type="number" min="-5.0" max="5.0" step="0.0001"><input id="whiteBalNumc" type="number" min="-5.0" max="5.0" step="0.0001">
			<a id="whiteBalApplyBtn" class="button" onclick="justRunSomething(this)">Apply</a>
		</div>


		<div id="camDisplayBox" class="horizLayout hidden">
			<b> Camera Display </b>
			<br>
			<span class="instruction"> Toggle the camera's display </span>
			<br>
			Display: <a id="displayToggleButton" class="button" onclick="toggler(this)">On</a>
		</div>



		<div id="recordModeBox" class="horizLayout">
			<b> Record Mode </b>
			<br>
			<span id="recordModeDescription" class="instruction">Select how video<br> is captured</span>
			<br>
			<div id="recordModeDropdown" class="selectContainerHolder" onclick=""> Normal <div class="selectContainer">
				<a onclick="dropDownSelect(this)">Normal</a>
				<a onclick="dropDownSelect(this)">Segmented</a>
				<a onclick="dropDownSelect(this)">Gated Burst</a>
<!--				<a onclick="dropDownSelect(this)">Live Slow Motion</a> -->
			</div></div>
			<div id="segmentNumberBox">
				Number of Segments:
				<input id="segmentNum" type="number" min="1" max="500" step="1" oninput="justRunSomething(this)">
				<br>
				Ring Buffer:
				<a id="disableRBButton" class="button" onclick="toggler(this)">Enabled</a>
			</div>
			<div id="prerecordBox">
				Prerecord Frames:
				<input id="preRecFrameNum" type="number" min="1" max="9000" step="1" oninput="changeNumberOften(this)">
				<br>
				Prerecord Time:
<!--				<input id="preRecTimeNum" type="number" min="0.0000" max="900.0000" step="0.001" oninput="changeNumberOften(this)"> ms
-->				<span id="preRecTimeNum">?? connecting</span>
			</div>
		</div>

		<div id="focusPeakingBox" class="horizLayout">
			<b> Focus Peaking </b>
			<br>
			<div id="focusPeakingLevelDropdown" class="selectContainerHolder" onclick="">Level<div class="selectContainer">
				<a onclick="dropDownSelect(this)">Low</a>
				<a onclick="dropDownSelect(this)">Medium</a>
				<a onclick="dropDownSelect(this)">High</a>
			</div></div>
			<br>
			<div id="focusPeakingColorDropdown" class="selectContainerHolder" onclick="">Color<div class="selectContainer">
				<a onclick="dropDownSelect(this)" style="background-color: black; color: white;">Black</a>
				<a onclick="dropDownSelect(this)" style="background-color: red; color: white;">Red</a>
				<a onclick="dropDownSelect(this)" style="background-color: cyan; color: black;">Cyan</a>
				<a onclick="dropDownSelect(this)" style="background-color: blue; color: white;">Blue</a>
				<a onclick="dropDownSelect(this)" style="background-color: yellow; color: black;">Yellow</a>
				<a onclick="dropDownSelect(this)" style="background-color: magenta; color white;">Magenta</a>
				<a onclick="dropDownSelect(this)" style="background-color: white; color: black;">White</a>
				<a onclick="dropDownSelect(this)" style="background-color: green; color: white;">Green</a>
			</div></div>
		</div>

		<div id="autoPowerBox" class="horizLayout">
			<b> Auto Power Mode </b>
			<br>
<!--			<span class="instruction"> Power on as soon as power is connected </span>
			<br>
-->
			<div id="autoPowerDropdown" class="selectContainerHolder" onclick=""> Disabled <div class="selectContainer">
				<a onclick="dropDownSelect(this)">Disabled</a>
				<a onclick="dropDownSelect(this)">Turn on if AC inserted</a>
				<a onclick="dropDownSelect(this)">Turn off if AC removed</a>
				<a onclick="dropDownSelect(this)">Both</a>
			</div></div>
		</div>



	</div>



	<div id="container2" class="rightContainer">


		<div class="horizLayout">
			<b> Trigger Delay </b>
			<br>
			<span class="instruction">Note: this only applies to external triggers</span>
			<br>
			<input id="postTriggerSlider" class="slider" type="range" min="0" max="1000000" oninput="changeNumberOften(this)">
			<div id="backgroundThing"></div>
			<br>

			Pre-record:
<!--			<span class="instruction"> Delay (Black) before recording buffer</span>-->
			<br>
			<span class="instruction"> Time from trigger to start of record buffer.<br>Black area before recording buffer</span>
			<br>
			Frames: <input id="preRecordFrameNum" type="number" min="0" max="1000000" step="1" oninput="changeNumberOften(this)">
			Time: <input id="preRecordTime" type="number" min="0" max="400" step="0.0001" oninput="changeNumberOften(this)"> s
			<br>
			<br>

			Pre-trigger:
<!--			<span class="instruction"> Record buffer (Red) left of the trigger (slider)</span>-->
			<br>
			<span class="instruction"> Time from start of record buffer to trigger.<br>Red area left of slider</span>
			<br>
			Frames: <input id="preTriggerFrameNum" type="number" min="0" max="50000" step="1" oninput="changeNumberOften(this)">
			Time: <input id="preTriggerTime" type="number" min="0" max="400" step="0.0001" oninput="changeNumberOften(this)"> s
			<br>
			<br>

			Post-trigger:
<!--			<span class="instruction"> Record buffer (Red) right of the trigger (slider)</span>-->
			<br>
			<span class="instruction"> Time from trigger to end of record buffer.<br>Red area right of slider</span>
			<br>
			Frames: <input id="postTriggerFrameNum" type="number" min="0" max="1000000" step="1" oninput="changeNumberOften(this)">
			Time: <input id="postTriggerTime" type="number" min="0" max="400" step="0.0001" oninput="changeNumberOften(this)"> s
			<br>

			<a id="morePreRecTime" class="button" onclick="justRunSomething(this)">More <br>Pre-rec Time</a>
			<a id="defaultTrigDelay" class="button" onclick="justRunSomething(this)">Reset to <br>Defaults</a>

		</div>


		<div id="smbStorageBox" class="horizLayout">
			<b> Windows/SMB Net. Storage </b>
			<br>
			Address: <input id="smbAddress" type="text" placeholder="123.45.67.89">
			<br>
			Mount:&emsp;<input id="smbMount" type="text" placeHolder="sharedFolder">
			<br>
			Username:&puncsp;<input id="smbUName" type="text" placeholder="squidFace">
			<br>
<!--			Password:&puncsp;<input id="smbPass" type="password" placeholder="s3cr3t"><a id="smbPassShowHide" class="button" onclick="toggler(this)">Show</a>
-->
			<a id="smbPassShowHide" class="button" onclick="toggler(this)" style="margin-left: 0;">Password:</a><input id="smbPass" type="password" placeholder="******">
			<br>
			<span class="instruction">Warning: this info is not encrypted!</span>
			<br>
			<a id="smbUnmountBtn" class="button" onclick="justRunSomething(this)">Unmount</a>
			<a id="smbTestBtn" class="button" onclick="justRunSomething(this)">Test</a>
			<a id="smbApplyBtn" class="button" style="float: right;" onclick="justRunSomething(this)">Apply</a>
		</div>
		<div id="nfsStorageBox" class="horizLayout">
			<b> Linux/NFS Network Storage </b>
			<br>
			Address: <input id="nfsAddress" type="text" placeholder="123.45.67.89">
			<br>
			Mount:&emsp;<input id="nfsMount" type="text" placeholder="drives/share">
			<br>
			<a id="nfsUnmountBtn" class="button" onclick="justRunSomething(this)">Unmount</a>
			<a id="nfsTestBtn" class="button" onclick="justRunSomething(this)">Test</a>
			<a id="nfsApplyBtn" class="button" style="float: right;" onclick="justRunSomething(this)">Apply</a>
		</div>





		<div id="refreshAllBox" class="horizLayout hidden">
			<b> Refresh Parameters </b>
			<br>
			<a id="refreshButton" class="button" onclick="dropDownSelect(this)">Update</a>
			<span class="instruction">This browser does not get alerted to changes from the camera. Use this button to update this page to match the camera</span>
		</div>


	</div>


	<div class="Text-bar">
		<div id="battery" class="no-click">
			<div id="batteryContainer" class="battery">
				<div id="battery-level"></div>
			</div>
			<span id="battery%">0%</span>
		</div>

		<a id="resetAll" onclick="justRunSomething(this)">Reset All Settings<br>to Default</a>
	</div>

	<div class="horizLayout">
		<b> About Camera </b>
		<br>
		<span id="cameraModel" class="infoText">Camera Model: </span>
		<span id="serialNumber" class="infoText">Serial Number: </span>
		<span id="cameraType" class="infoText">BW / Color </span>
		<span id="releaseVersion" class="infoText">Release Version: </span>
<!--		<span id="releaseCodename" class="infoText">Release Codename: </span>
		<span id="build">Build: </span>
-->
		<span id="FPGARev" class="infoText">FPGA Revision: </span>
		<span id="PMICVersion" class="infoText">PMIC Firmware Revision: </span>
		<span id="sensorTemp" class="infoText">Sensor Temperature: </span>
		<span id="systemTemp" class="infoText">System Temperature: </span>
		<span id="shutdownReason" class="infoText">Last Shutdown Reason: </span>
	</div>


	<div id="debugBar" class="Text-bar hidden">
		<a id="tester1" onclick="tester1func()"> tester1 </a>
		<a id="tester2" onclick="tester2func()"> tester2 </a>
		<a id="tester3" onclick="tester3func()"> tester3 </a>
		<a id="debugToggle" onclick="toggler(this)"> Display Messages </a>
		<div class="no-click"></div>
		<a onclick='theme("default")'> Default Theme </a>
		<a onclick='theme("monochrome")'> Mono Theme </a>
		<a onclick='theme("darker")'> Darker Theme </a>
		<a onclick='theme("lighter")'> Lighter Theme </a>
		<a onclick='theme("monoDark")'> Mono Dark </a>
		<a onclick='theme("newDefault")'> Light Theme2 </a>
	</div>
	<br>
	<span id="debugger">  </span>

	<span id="debugger2">  </span>
 </div>

<br>
<div class="matchBackground"> This page was made by Nicholas Faliszewski </div>


<div id="popUpBackground" class="popUpBackground hidden">
	<div id="messageWarn" class="popUpMessage">
		<div id="netShareResultBox" class="horizLayout hidden">
			Status of the network share requests
			<br>
			<a style="float: right;" class="button" onclick="dropDownSelect(this)">Ok</a>
		</div>
		<div id="somethingWeirdBox" class="horizLayout hidden">
			Something weird is happening
		</div>
	</div>
</div>

</body>

<script>

var DebugOnOff = false ;

function resetAll() {
	// reset all the settings


	// reset all cookies

	var expiryDate = new Date() ;

	expiryDate.setTime(expiryDate.getTime() - 10) ; // already expired

	document.cookie = "as=''; expires=" + expiryDate.toUTCString() + "; path=/" ; // clear auto-save/save-device cookie
	document.cookie = "ff=''; expires=" + expiryDate.toUTCString() + "; path=/" ; // clear file format cookie
	document.cookie = "fpl=''; expires=" + expiryDate.toUTCString() + "; path=/" ; // clear focus peaking level cookie
	document.cookie = "mc=''; expires=" + expiryDate.toUTCString() + "; path=/" ; // clear mode change cookie
	document.cookie = "thm=''; expires=" + expiryDate.toUTCString() + "; path=/" ; // clear theme cookie
	document.cookie = "wo=''; expires=" + expiryDate.toUTCString() + "; path=/" ; // clear warn-overwrite cookie

	theme("default") ;

	// set state to idle
	dataRequester("startLivedisplay", "{}", pageUpdate) ;

	// clear recorded buffer
	dataGetter("flushRecording", '', pageUpdate) ;

	var bigRequest = '{' ;
	bigRequest += '"recMode": "normal"' ; // record mode to normal
//	bigRequest += ', "resolution": {"hRes": 1280, "vRes": 1024, "minFrameTime": 0.00093545}' ; // resolution to default
	bigRequest += ', "recTrigDelay": 0' ; // trigger delay to default
	bigRequest += ', "focusPeakingColor": "cyan"' ; // set focus peaking color to cyan
	bigRequest += ', "focusPeakingLevel": 0' ; // set focus peaking level to default (off)
	bigRequest += ', "zebraLevel": 0' ; // turn off zebra stripes
	bigRequest += ', "powerOffWhenMainsLost": false, "powerOnWhenMainsConnected": false' ; // disable auto-power mode
	bigRequest += ', "currentGain": 1' ; // reset analog gain
	bigRequest += ', "wbTemperature": 5600' ; // reset white balance to default color temperature
	bigRequest += ', "disableRingBuffer": 0' ; // ensure the ring buffer is enabled
	bigRequest += '}' ;

	dataRequester("set", bigRequest, pageUpdate) ; // apply all these settings

	extender = 0 ; // clear the trigger delay extender as well

	// set color matrix to default
	detourRequester("set", '{"colorMatrix": [1.91455, -0.57666, -0.234131,  -0.30542, 1.3894, -0.0966797,  0.127197, -0.952881, 1.64917]}', pageUpdate) ;

	// to-do later:
		// reset all IO settings to default / cleared values

}


function tester1func() {
//	dataRequester("set", '{"recPreBurst": ' + document.getElementById("preRecFrameNum").value + '}', pageUpdate) ;

}

function tester2func() {

//	dataGetter("p", "", pageUpdate) ; // get all the data
}


function tester3func() {
	// clear recorded buffer
	dataGetter("flushRecording", '', pageUpdate) ;

}


function boundInput(element) {
	if (parseInt(element.value) > parseInt(element.max))
		element.value = element.max ;
	else if (parseInt(element.value) < parseInt(element.min))
		element.value = element.min ;
}

var extender = 0 ;

function changeNumberOften(element) {
	if (typeof changeNumberOften.requestCount == 'undefined') // kind of like a static variable
		changeNumberOften.requestCount = 0 ;

	boundInput(element) ; // make sure the input number is not too high or too low

	if (element.id == "preRecFrameNum") {

		var callWhenFinished = function(inputParams) { // set the callback / finished function
			pageUpdate(inputParams) ; // actually update the page
			changeNumberOften.requestCount -= 1 ; // allow another request
		}
		if (changeNumberOften.requestCount < 1) {
			changeNumberOften.requestCount += 1 ;
			dataRequester("set", '{"recPreBurst": ' + element.value + '}', callWhenFinished) ; // set the current fram (playback position)
		}
	}
	else {
		if (element.id == "preRecordFrameNum") {
			document.getElementById("preTriggerFrameNum").value = 0 ; // can't use preRecord and preTrigger together
			document.getElementById("postTriggerFrameNum").value = parseInt(lastKnownMaxRecFrames + parseInt(element.value)) ; // postRecord is the sum of preRecord and max frames
		}
		else if (element.id == "preTriggerFrameNum") {
			document.getElementById("preRecordFrameNum").value = 0 ; // can't use preRecord and preTrigger together
			document.getElementById("postTriggerFrameNum").value = parseInt(lastKnownMaxRecFrames - parseInt(element.value)) ; // post trigger is the difference between max frames and preTrigger
		}
		else if (element.id == "postTriggerFrameNum") {
			if (parseInt(element.value) > lastKnownMaxRecFrames) { // pre-record delay is being used
				document.getElementById("preRecordFrameNum").value = parseInt(element.value) - lastKnownMaxRecFrames ;
				document.getElementById("preTriggerFrameNum").value = 0 ; // can't use preRecord and preTrigger together
			}
			else {
				document.getElementById("preRecordFrameNum").value = 0 ; // can't use preRecord and preTrigger together
				document.getElementById("preTriggerFrameNum").value = lastKnownMaxRecFrames - parseInt(element.value) ;
			}
		}
		else if (element.id == "preRecordTime") {
			var frames = Math.round(parseInt(element.value) * lastKnownFramePeriod / 1000) ;
			document.getElementById("postTriggerFrameNum").value = parseInt(frames + lastKnownMaxRecFrames) ;
		}
		else if (element.id == "preTriggerTime") {
			var frames = Math.round(parseInt(element.value) * lastKnownFramePeriod / 1000) ;
			document.getElementById("postTriggerFrameNum").value = parseInt(lastKnownMaxRecFrames - frames) ;
		}
		else if (element.id == "postTriggerTime") {
			var frames = Math.round(parseInt(element.value) * lastKnownFramePeriod / 1000) ;
			document.getElementById("postTriggerFrameNum").value = frames ;
		}
		else if (element.id == "postTriggerSlider") {
			document.getElementById("postTriggerFrameNum").value = parseInt(element.value) - extender ;
			document.getElementById("postTriggerFrameNum").value = element.max - parseInt(element.value) ;
			document.getElementById("backgroundThing").style.borderLeftWidth = ( extender / (extender + lastKnownMaxRecFrames) * document.getElementById("postTriggerSlider").offsetWidth ) + "px" ;
		}

		var callWhenFinished = function(inputParams) { // set the callback / finished function
			pageUpdate(inputParams) ; // update the page
			changeNumberOften.requestCount -= 1 ; // allow another request
		}
		if (changeNumberOften.requestCount < 1) {
			changeNumberOften.requestCount += 1 ;
			dataRequester("set", '{"recTrigDelay": ' + document.getElementById("postTriggerFrameNum").value + '}', callWhenFinished) ; // set the trigger delay frame count
		}

	}
}




function getCookie(cname) {
  var name = cname + "=";
  var ca = document.cookie.split(';');
  for(var i = 0; i < ca.length; i++) {
    var c = ca[i];
    while (c.charAt(0) == ' ') {
      c = c.substring(1);
    }
    if (c.indexOf(name) == 0) {
      return c.substring(name.length, c.length);
    }
  }
  return "";
}







function setCookie (name, value) {
	var expiryDate = new Date() ;

	expiryDate.setTime(expiryDate.getTime() + 1000*60*60*24*90) ; // add 90 days (time is in ms)

	document.cookie = name + "=" + value + "; expires=" + expiryDate.toUTCString() + "; path=/" ;
}


if (detectIE()) {
	if (DebugOnOff)
		document.getElementById("debugger2").innerHTML = "MS Browser detected" ;
	
	document.getElementById("windozeFixer").href = "css/windozeFixes.css" ;
	
	if ( (parseInt(detectIE()) <= 16) ) { // detect an older version (especially IE)
		if (DebugOnOff)
			document.getElementById("debugger2").innerHTML += " -- Seems to be Internet Explorer" ;
			
		var inputList = document.getElementsByTagName("input"); // get all 'input' types
		for (var i = 0 ; i < inputList.length ; i++) {
			if ( (inputList[i].type.toLowerCase() == "number") || (inputList[i].type.toLowerCase() == "text") )
				inputList[i].style.paddingBottom = "9px" ; // add some padding to the bottom of number or text inputs
		}
		
		document.getElementById("postTriggerSlider").addEventListener('change', function() { changeNumberOften(document.getElementById("postTriggerSlider")) ; }) ;
	}
}



function detectIE() {
  var ua = window.navigator.userAgent;

  // Test values; Uncomment to check result …

  // IE 10
  // ua = 'Mozilla/5.0 (compatible; MSIE 10.0; Windows NT 6.2; Trident/6.0)';
  
  // IE 11
  // ua = 'Mozilla/5.0 (Windows NT 6.3; Trident/7.0; rv:11.0) like Gecko';
  
  // Edge 12 (Spartan)
  // ua = 'Mozilla/5.0 (Windows NT 10.0; WOW64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/39.0.2171.71 Safari/537.36 Edge/12.0';
  
  // Edge 13
  // ua = 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/46.0.2486.0 Safari/537.36 Edge/13.10586';

  var msie = ua.indexOf('MSIE ');
  if (msie > 0) {
    // IE 10 or older => return version number
    return parseInt(ua.substring(msie + 5, ua.indexOf('.', msie)), 10);
  }

  var trident = ua.indexOf('Trident/');
  if (trident > 0) {
    // IE 11 => return version number
    var rv = ua.indexOf('rv:');
    return parseInt(ua.substring(rv + 3, ua.indexOf('.', rv)), 10);
  }

  var edge = ua.indexOf('Edge/');
  if (edge > 0) {
    // Edge (IE 12+) => return version number
    return parseInt(ua.substring(edge + 5, ua.indexOf('.', edge)), 10);
  }

  // other browser
  return false;
}



function theme(selection) { // set a new stylesheet to use

	if ( (selection == "default") || (selection == "monochrome") || (selection == "darker") || (selection == "lighter") || (selection == "monoDark") || (selection == "newDefault") ) {
		document.getElementById("themeSelection").href = "/css/" + selection + "Theme.css" ;

//		VideoOutlineStyle = document.getElementById("videoDisplay").style.border ; // get the style of the border

		switch (selection) {
			case "":
			case "default":
				document.getElementById("themeSelector").firstChild.textContent = "Default" ;
				setCookie("thm", "dt") ; // save the theme to a cookie for persistance
				break ;

			case "monochrome":
				document.getElementById("themeSelector").firstChild.textContent = "Monochrome" ;
				setCookie("thm", "mo") ; // save the theme to a cookie for persistance
				break ;

			case "darker":
				document.getElementById("themeSelector").firstChild.textContent = "Dark" ;
				setCookie("thm", "dk") ; // save the theme to a cookie for persistance
				break ;

			case "lighter":
				document.getElementById("themeSelector").firstChild.textContent = "Light 2" ;
				setCookie("thm", "lt") ; // save the theme to a cookie for persistance
				break ;

			case "monoDark":
				document.getElementById("themeSelector").firstChild.textContent = "Mono Dark" ;
				setCookie("thm", "md") ; // save the theme to a cookie for persistance
				break ;

			case "newDefault":
				document.getElementById("themeSelector").firstChild.textContent = "Light" ;
				setCookie("thm", "l2") ; // save the theme to a cookie for persistance
				break ;

			default:
				document.getElementById("themeSelector").firstChild.textContent = "Theme Selection" ;
		}
	}
}

var dropDownFunctions = { "Debug Tools":	function(){ var item = document.getElementById("debugBar") ; if (item.classList.contains("hidden")) { item.classList.remove("hidden") ; } else { item.classList.add("hidden") ; } },
						"Play Mode":		function() { dataRequester("startPlayback", '{"framerate": 0}', pageUpdate) ; },
						"Record Mode":		function() { dataRequester("startLivedisplay", "{}", pageUpdate) ; },

						"Low":				function() { setCookie("fpl", 0.33) ; dataGetter("get", "focusPeakingLevel", pageUpdate) ; document.getElementById("focusPeakingLevelDropdown").firstChild.textContent = " Low " ; },
						"Medium":			function() { setCookie("fpl", 0.67) ; dataGetter("get", "focusPeakingLevel", pageUpdate) ; document.getElementById("focusPeakingLevelDropdown").firstChild.textContent = "Medium" ; },
						"High":				function() { setCookie("fpl", 1.0) ; dataGetter("get", "focusPeakingLevel", pageUpdate) ; document.getElementById("focusPeakingLevelDropdown").firstChild.textContent = " High "; },

						"Black":			function() { dataSender("set", '{"focusPeakingColor": "black"}') ; document.getElementById("focusPeakingColorDropdown").firstChild.textContent = " Black " ; },
						"Red":				function() { dataSender("set", '{"focusPeakingColor": "red"}') ; document.getElementById("focusPeakingColorDropdown").firstChild.textContent = " Red " ; },
						"Cyan":				function() { dataSender("set", '{"focusPeakingColor": "cyan"}') ; document.getElementById("focusPeakingColorDropdown").firstChild.textContent = " Cyan " ; },
						"Blue":				function() { dataSender("set", '{"focusPeakingColor": "blue"}') ; document.getElementById("focusPeakingColorDropdown").firstChild.textContent = " Blue " ; },
						"Yellow":			function() { dataSender("set", '{"focusPeakingColor": "yellow"}') ; document.getElementById("focusPeakingColorDropdown").firstChild.textContent = "Yellow" ; },
						"Magenta":			function() { dataSender("set", '{"focusPeakingColor": "magenta"}') ; document.getElementById("focusPeakingColorDropdown").firstChild.textContent = "Magenta" ; },
						"White":			function() { dataSender("set", '{"focusPeakingColor": "white"}') ; document.getElementById("focusPeakingColorDropdown").firstChild.textContent = " White " ; },
						"Green":			function() { dataSender("set", '{"focusPeakingColor": "green"}') ; document.getElementById("focusPeakingColorDropdown").firstChild.textContent = " Green " ; },

						"Always":			function() { setCookie("wo", "a") ; document.getElementById("recordWarn").firstChild.textContent = "Always" ; },
						"Never":			function() { setCookie("wo", "n") ; document.getElementById("recordWarn").firstChild.textContent = "Never" ; },
						"If Unsaved":		function() { setCookie("wo", "u") ; document.getElementById("recordWarn").firstChild.textContent = "In Unsaved" ; },

						"Manually":			function() { setCookie("mc", "m") ; document.getElementById("changeModeDropdown").firstChild.textContent = "Manually" ; },
						"On Navigate":		function() { setCookie("mc", "n") ; document.getElementById("changeModeDropdown").firstChild.textContent = "On Navigation" ; },

						"Normal":			function() { dataRequester("set", '{"recMode": "normal", "disableRingBuffer": 0}', pageUpdate) ; },
						"Segmented":		function() { dataRequester("set", '{"recMode": "segmented"}', pageUpdate) ; },
						"Gated Burst":		function() { dataRequester("set", '{"recMode": "burst", "disableRingBuffer": 0}', pageUpdate) ; },

						"Disabled":			function() { dataRequester("set", '{"powerOffWhenMainsLost": false, "powerOnWhenMainsConnected": false}', pageUpdate) ; },
						"Turn on if AC inserted": function() { dataRequester("set", '{"powerOffWhenMainsLost": false, "powerOnWhenMainsConnected": true}', pageUpdate) ; },
						"Turn off if AC removed": function() { dataRequester("set", '{"powerOffWhenMainsLost": true, "powerOnWhenMainsConnected": false}', pageUpdate) ; },
						"Both":				function() { dataRequester("set", '{"powerOffWhenMainsLost": true, "powerOnWhenMainsConnected": true}', pageUpdate) ; },

						"Ok":				function() { document.getElementById("popUpBackground").classList.add("hidden") ; document.getElementById("netShareResultBox").classList.add("hidden") ;  dataGetter('get', 'externalStorage', pageUpdate) ; },

						}


function dropDownSelect (element) {
	if (element.innerText in dropDownFunctions) // if the key-value exists
		dropDownFunctions[element.innerText]() ; // run the function
}

function netStorageRequest(command, type) {

	if (type == "nfs") {
		var address = document.getElementById("nfsAddress").value ;
		var mount = document.getElementById("nfsMount").value ;
	}
	else {
		var address = document.getElementById("smbAddress").value ;
		var mount = document.getElementById("smbMount").value ;
	}

	var requestSender = new XMLHttpRequest() ;
	var parameters = "" ;

	if (command == "unmount") { // unmount the network drive
		if (type == "nfs")
			parameters = "nfs=unmount" ;
		else if (type == "smb")
			parameters = "smb=unmount" ;

		document.getElementById("popUpBackground").classList.remove("hidden") ;
		document.getElementById("netShareResultBox").firstChild.textContent = "Requesting that the shared drive be disconncted..." ;
		document.getElementById("netShareResultBox").classList.remove("hidden") ;
	}
	else if (command == "test") { // run the test input
		if (type == "nfs")
			parameters = "nfs=test" ;
		else if (type == "smb")
			parameters = "smb=test" ;

		document.getElementById("popUpBackground").classList.remove("hidden") ;
		document.getElementById("netShareResultBox").firstChild.textContent = "Testing the share drive (trying to write a file and read it back)..." ;
		document.getElementById("netShareResultBox").classList.remove("hidden") ;
	}
	else if ( (address == "") || (mount == "") ) {
		document.getElementById("popUpBackground").classList.remove("hidden") ;
		document.getElementById("netShareResultBox").firstChild.textContent = "Please enter an IP address and a mount location" ;
		document.getElementById("netShareResultBox").classList.remove("hidden") ;
		return (0) ;
	}
	else {
		if (mount[0] != "/")
		mount = "/" + mount ; // add leading "/" if it wasn't already there
		
		if (type == "nfs") {
			parameters = "nfs=" + address + "&mount=" + mount ;
			document.getElementById("netShareResultBox").firstChild.textContent = "Attempting to connect to NFS share..." ;
		}
		else if (type == "smb") {
			parameters = "smb=" + address + "&mount=" + mount + "&" + document.getElementById("smbUName").value + "=" + document.getElementById("smbPass").value ;
			document.getElementById("netShareResultBox").firstChild.textContent = "Attempting to connect to SMB share..." ;
		}

		// show the status
		document.getElementById("popUpBackground").classList.remove("hidden") ;
		document.getElementById("netShareResultBox").classList.remove("hidden") ;
	}

	requestSender.onreadystatechange = function(){ // do something with the response
		if (this.readyState == 4 && this.status == 200){
			if (requestSender.responseText == "") // got nothing back
				document.getElementById("netShareResultBox").firstChild.textContent = "Camera could not connect" ;
			else {
				var jsonBack = JSON.parse(requestSender.responseText) ; // convert to json
				if ("error" in jsonBack)
					document.getElementById("netShareResultBox").firstChild.textContent = jsonBack.error ;
				else
					document.getElementById("netShareResultBox").firstChild.textContent = "Success!" ;
			}

			// show the status
			document.getElementById("popUpBackground").classList.remove("hidden") ;
			document.getElementById("netShareResultBox").classList.remove("hidden") ;

		}
	}

	requestSender.open("GET", "/cgi-bin/netShare?" + parameters) ;
	requestSender.setRequestHeader("Content-Type", "application/json") ;


	requestSender.send() ;

}


var inputFunctions = { "segmentNum":			function(value) { dataRequester("set", '{"recSegments": ' + value + '}', pageUpdate) ; },

						"colourDefaultBtn":		function() { detourRequester("set", '{"colorMatrix": [1.91455, -0.57666, -0.234131,  -0.30542, 1.3894, -0.0966797,  0.127197, -0.952881, 1.64917]}', pageUpdate) ; },
						"colourIdentityBtn":	function() { detourRequester("set", '{"colorMatrix": [1.0, 0.0, 0.0,  0.0, 1.0, 0.0,  0.0, 0.0, 1.0]}', pageUpdate) ; },
						"colourApplyBtn":		function() { detourRequester("set", '{"colorMatrix": [' + document.getElementById("colMatrixa").value + ', ' + document.getElementById("colMatrixb").value + ', ' + document.getElementById("colMatrixc").value + ', ' + document.getElementById("colMatrixd").value + ', ' + document.getElementById("colMatrixe").value + ', ' + document.getElementById("colMatrixf").value + ', ' + document.getElementById("colMatrixg").value + ', ' + document.getElementById("colMatrixh").value + ', ' + document.getElementById("colMatrixi").value + ']}', pageUpdate) ; },
						"colourPreset1Btn":		function() { detourRequester("set", '{"colorMatrix": [1.91455, -0.57666, -0.234131,  -0.30542, 1.3894, -0.0966797,  0.127197, -0.952881, 1.64917]}', pageUpdate) ; },
						"colourPreset2Btn":		function() { detourRequester("set", '{"colorMatrix": [1.23291, 0.646729, -0.776367,  -0.321777, 1.68994, -0.380859,  -0.0612793, -0.640869,1.52563]}', pageUpdate) ; },

						"whiteBalApplyBtn":		function() { detourRequester("set", '{"wbColor": [' + document.getElementById("whiteBalNuma").value + ', ' + document.getElementById("whiteBalNumb").value + ', ' + document.getElementById("whiteBalNumc").value + ']}', pageUpdate) ; },

						"resetAll":				function() { resetAll() ; },

						"morePreRecTime":		function() { extender += lastKnownMaxRecFrames ; document.getElementById("postTriggerSlider").max = lastKnownMaxRecFrames + extender ; document.getElementById("postTriggerSlider").value = parseInt(document.getElementById("postTriggerSlider").value) + lastKnownMaxRecFrames ; document.getElementById("postTriggerFrameNum").value = document.getElementById("postTriggerSlider").max - parseInt(document.getElementById("postTriggerSlider").value) ; document.getElementById("backgroundThing").style.borderLeftWidth = ( extender / (extender + lastKnownMaxRecFrames) * document.getElementById("postTriggerSlider").offsetWidth ) + "px" ; },
						"defaultTrigDelay":		function() { extender = 0 ; dataRequester("set", '{"recTrigDelay": 0}', pageUpdate) ; },

						"nfsTestBtn":			function() { if (!document.getElementById("nfsTestBtn").classList.contains("disabled")) { netStorageRequest("test", "nfs") ; } },
						"nfsApplyBtn":			function() { netStorageRequest("mount", "nfs") ; },
						"nfsUnmountBtn":		function() { if (!document.getElementById("nfsUnmountBtn").classList.contains("disabled")) {netStorageRequest("unmount", "nfs") ; } },
						
						"smbTestBtn":			function() { if (!document.getElementById("smbTestBtn").classList.contains("disabled")) { netStorageRequest("test", "smb") ; } },
						"smbApplyBtn":			function() { netStorageRequest("mount", "smb") ; },
						"smbUnmountBtn":		function() { if (!document.getElementById("smbUnmountBtn").classList.contains("disabled")) {netStorageRequest("unmount", "smb") ; } },
					 }


function justRunSomething(element) {
	if (element.id in inputFunctions) // if the key-value exists
		inputFunctions[element.id](element.value) ; // run the function (with the value given)
}



document.getElementById("menu").onmouseenter = function(){ document.getElementById("menuList").style.display = "block" ; }
document.getElementById("menu").onmouseleave = function() {
	var otherMenu = document.getElementById("menuList") ;
	setTimeout( function() {
		if (!document.getElementById("menu").classList.contains("active"))
			document.getElementById("menuList").style.display = "" ;
	}, 50) ;
}


if (!Element.prototype.matches) {
  Element.prototype.matches = Element.prototype.msMatchesSelector;
}

window.onclick = function(event) { // check where a click was: if it was outside a menu, close that menu
	if ( !event.target.matches(".menuClickOk") && (event.target.parent == undefined || !event.target.parent.matches(".menuClickOk"))
	&& (document.getElementById("menu").matches(".active")) ) {
		toggler(document.getElementById("menu")) ; // toggle off the button (and close the menu)
	}
}


					//	 key	 	 inactive		active
var nameChange = {	"displayToggleButton":	[ "Off", "On" ],
					"autoSaveButton":		[ "No", "Yes" ],

					"disableRBButton":		[ "Enabled", "Disabled" ],
//					"smbPassShowHide":		[ "Show", "Hide" ],
				}

var buttonFunctions = {	"menu":			[ function(){ document.getElementById("menuList").style.display = "" ; }, function(){ menuKeeper() ; document.getElementById("menuList").style.display = "block" ;} ],					

						"debugToggle":			[ function(){ DebugOnOff = false ; document.getElementById("debugger").innerHTML = "" ; document.getElementById("debugger2").innerHTML = "" ; }, function() { DebugOnOff = true ; } ],
						"displayToggleButton":	[ function(){ dataRequester("set", '{"backlightEnabled": false}', pageUpdate) ; }, function(){ dataRequester("set", '{"backlightEnabled": true}', pageUpdate) ; } ],
						"autoSaveButton":		[ function(){ if (getCookie("as") > 0) { setCookie("as", parseInt(getCookie("as") * -1)) ; } else { setCookie("as", 0) ; } }, function() { if (getCookie("as") < 0) { setCookie("as", parseInt(getCookie("as") * -1)) ; } else { setCookie("as", 1) ; } } ],

						"disableRBButton":		[ function(){ dataSender("set", '{"disableRingBuffer": 0}') ; }, function() { dataSender("set", '{"disableRingBuffer": 1}') ; } ],
						"smbPassShowHide":		[ function(){ document.getElementById("smbPass").type="password" ; document.getElementById("smbPass").placeholder="******" ; }, function(){ document.getElementById("smbPass").type="text" ; document.getElementById("smbPass").placeholder="s3cr3t" ; } ],
					  }


function toggler(element) { // toggle the class (active/inactive), change the name, and run a function for a toggle button/switch
	var leftRight = 0 ;

	if (element.classList.contains("active")) { // changing to 'inactive' or no state set previously
		element.classList.remove("active") ; // remove the "active" styling
		element.classList.add("inactive") ; // use the "inactive" styling
		leftRight = 0 ; // use the 'left' column for names / functions
	}
	else if (element.classList.contains("disabled")) { // button disabled
		return ; // don't do anything
	}
	else {
		element.classList.remove("inactive") ; // remove the "inactive" styling
		element.classList.add("active") ; // use the "active" styling
		leftRight = 1 ; // use the 'right' column for names / functions
	}

	if (element.id in nameChange) // check if key-value exists
		element.innerHTML = nameChange[element.id][leftRight] ; // set name to the left (inactive) or right (active) one

	if (element.id in buttonFunctions) // if the key-value exists
		buttonFunctions[element.id][leftRight]() ; // run the left (inactive) or right (active) function
}

function stateSelecter(element, state) { // this is like toggler above, but doesn't run the function ; set the class (active/inactive), change the name

	if (state) { // switch to active
		element.classList.remove("inactive") ; // remove the "inactive" styling
		element.classList.add("active") ; // use the "active" styling
	}
	else { // switch to inactive
		element.classList.remove("active") ; // remove the "active" styling
		element.classList.add("inactive") ; // use the "inactive" styling
	}

	state *= 1 ;

	if (element.id in nameChange) // check if key-value exists
		element.innerHTML = nameChange[element.id][state] ; // set name to the left (inactive) or right (active) one
}


function menuKeeper() {
	document.getElementById("menu").classList.remove("inactive");
	document.getElementById("menu").classList.add("active");
}


function batteryPercent(level, charging) { // set the percentage (level) of the battery (and whether it's charging)
	var indicator = document.getElementById("battery-level") ;
	var text = document.getElementById("battery%") ;

	if (level <= 100 && level >= 0) { // not charging (and level is ok)
		text.innerHTML = level.toString() + "%" ;


		if (charging) {
			indicator.style.height = "100%" ; // just make the level full when charging
			indicator.style.backgroundColor = "white" ; // white background while charging
			indicator.innerHTML = '<div id="chargeIcon" class="hidden"></div>' ; // add the charging indicator
		}
		else {
			indicator.style.height = level.toString() + "%" ;
			indicator.innerHTML = '' ; // clear the charging icon

			if (level <= 20)
				indicator.style.backgroundColor = "#a00" ; // red (low)
			else if (level <= 55)
				indicator.style.backgroundColor = "#e7ba00" ; // yellow (less than half)
			else
				indicator.style.backgroundColor = "green" ; // green (fine / more than half)
		}
	}
}


var lastKnownBatteryLevel = 0 ;
var lastKnownExternalPower = false ;

var lastKnownFramePeriod = 0 ;
var lastKnownMaxRecFrames = 0 ;

function pageUpdate(rawData){
	var parsedData = JSON.parse(rawData) ;

	if (DebugOnOff)
		document.getElementById("debugger").innerHTML += "<br><br>got info:" + rawData ;

	if ("batteryChargePercent" in parsedData) {
		lastKnownBatteryLevel = Math.round(parsedData.batteryChargePercent) ; // set the last known battery percent value
		batteryPercent(lastKnownBatteryLevel, lastKnownExternalPower) ; // update the battery indicator
	}

	if ("externalPower" in parsedData) {
		lastKnownExternalPower = parsedData.externalPower ; // set the last known power connection
		batteryPercent(lastKnownBatteryLevel, lastKnownExternalPower) ; // update the battery indicator
	}

	if ("focusPeakingLevel" in parsedData) {
		if (parsedData.focusPeakingLevel != 0) {
			if ( (getCookie("fpl") != "") && (getCookie("fpl") != parsedData.focusPeakingLevel) )
			dataSender("set", '{"focusPeakingLevel": ' + getCookie("fpl") + '}') ;
		}
	}

	if ("focusPeakingColor" in parsedData) {
		switch (parsedData.focusPeakingColor) {
			case "black":
				document.getElementById("focusPeakingColorDropdown").firstChild.textContent = " Black " ;
				break ;

			case "red":
				document.getElementById("focusPeakingColorDropdown").firstChild.textContent = " Red " ;
				break ;

			case "cyan":
				document.getElementById("focusPeakingColorDropdown").firstChild.textContent = " Cyan " ;
				break ;

			case "blue":
				document.getElementById("focusPeakingColorDropdown").firstChild.textContent = " Blue " ;
				break ;

			case "yellow":
				document.getElementById("focusPeakingColorDropdown").firstChild.textContent = "Yellow" ;
				break ;

			case "magenta":
				document.getElementById("focusPeakingColorDropdown").firstChild.textContent = "Magenta" ;
				break ;

			case "white":
				document.getElementById("focusPeakingColorDropdown").firstChild.textContent = " White " ;
				break ;

			case "green":
				document.getElementById("focusPeakingColorDropdown").firstChild.textContent = " Green " ;
				break ;
		}
	}

	if ("recMode" in parsedData) {
		switch (parsedData.recMode) {
			case "normal":
				document.getElementById("recordModeDropdown").firstChild.textContent = " Normal " ;
				document.getElementById("segmentNumberBox").classList.add("hidden") ;
				document.getElementById("prerecordBox").classList.add("hidden") ;
				document.getElementById("recordModeDescription").innerHTML = "Select how video<br> is captured" ;
				document.getElementById("focusPeakingBox").classList.remove("wrapAround") ;
				break ;

			case "segmented":
				document.getElementById("recordModeDropdown").firstChild.textContent = "Segmented" ;
				document.getElementById("segmentNumberBox").classList.remove("hidden") ;
				document.getElementById("prerecordBox").classList.add("hidden") ;
				document.getElementById("recordModeDescription").innerHTML = "Select how video is captured" ;
				document.getElementById("focusPeakingBox").classList.add("wrapAround") ;
				break ;

			case "burst":
				document.getElementById("recordModeDropdown").firstChild.textContent = "Gated Burst" ;
				document.getElementById("segmentNumberBox").classList.add("hidden") ;
				document.getElementById("prerecordBox").classList.remove("hidden") ;
				document.getElementById("recordModeDescription").innerHTML = "Select how video is captured" ;
				document.getElementById("focusPeakingBox").classList.add("wrapAround") ;
				break ;
		}
	}

	if ("recSegments" in parsedData) {
		if (document.getElementById("segmentNum") != document.activeElement)
			document.getElementById("segmentNum").value = parsedData.recSegments ;
	}

	if ("disableRingBuffer" in parsedData)
		stateSelecter(document.getElementById("disableRBButton"), parsedData.disableRingBuffer) ; // set the ring buffer status to enabled or disabled


	if ( ("powerOnWhenMainsConnected" in parsedData) && ("powerOffWhenMainsLost" in parsedData) ) {

		if ( (parsedData.powerOnWhenMainsConnected == true) && (parsedData.powerOffWhenMainsLost == true) )
			document.getElementById("autoPowerDropdown").firstChild.textContent = "Both" ;
		else if ( (parsedData.powerOnWhenMainsConnected == true) && (parsedData.powerOffWhenMainsLost == false) )
			document.getElementById("autoPowerDropdown").firstChild.textContent = "Turn on if AC Inserted" ;
		else if ( (parsedData.powerOnWhenMainsConnected == false) && (parsedData.powerOffWhenMainsLost == true) )
			document.getElementById("autoPowerDropdown").firstChild.textContent = "Turn off if AC Removed" ;
		else if ( (parsedData.powerOnWhenMainsConnected == false) && (parsedData.powerOffWhenMainsLost == false) )
			document.getElementById("autoPowerDropdown").firstChild.textContent = "Disabled" ;
	}

	if ("backlightEnabled" in parsedData) { // turn the rear screen on or off
		stateSelecter(document.getElementById("displayToggleButton"), parsedData.backlightEnabled) ;
		if (DebugOnOff)
			document.getElementById("debugger").innerHTML += "\nGot backlight command: " + parsedData.backlightEnabled ;
	}

	if ("colorMatrix" in parsedData) {
		document.getElementById("colMatrixa").value = parsedData.colorMatrix[0].toFixed(4) ;
		document.getElementById("colMatrixb").value = parsedData.colorMatrix[1].toFixed(4) ;
		document.getElementById("colMatrixc").value = parsedData.colorMatrix[2].toFixed(4) ;

		document.getElementById("colMatrixd").value = parsedData.colorMatrix[3].toFixed(4) ;
		document.getElementById("colMatrixe").value = parsedData.colorMatrix[4].toFixed(4) ;
		document.getElementById("colMatrixf").value = parsedData.colorMatrix[5].toFixed(4) ;

		document.getElementById("colMatrixg").value = parsedData.colorMatrix[6].toFixed(4) ;
		document.getElementById("colMatrixh").value = parsedData.colorMatrix[7].toFixed(4) ;
		document.getElementById("colMatrixi").value = parsedData.colorMatrix[8].toFixed(4) ;
	}

	if ("wbColor" in parsedData) {
		document.getElementById("whiteBalNuma").value = parsedData.wbColor[0].toFixed(4) ;
		document.getElementById("whiteBalNumb").value = parsedData.wbColor[1].toFixed(4) ;
		document.getElementById("whiteBalNumc").value = parsedData.wbColor[2].toFixed(4) ;
	}

	if ("framePeriod" in parsedData)
		lastKnownFramePeriod = parsedData.framePeriod ;

	if ("recPreBurst" in parsedData) {
		document.getElementById("preRecFrameNum").value = parsedData.recPreBurst ; // set the prerecord frames
		document.getElementById("preRecTimeNum").innerHTML = (parsedData.recPreBurst * lastKnownFramePeriod / 1000000).toFixed(3) + " ms"
	}

	if ("recMaxFrames" in parsedData) {
		document.getElementById("preRecFrameNum").max = parsedData.recMaxFrames ; // set the recording frame limit
		document.getElementById("preTriggerFrameNum").max = parsedData.recMaxFrames ; // set the pre-trigger limit
		lastKnownMaxRecFrames = parsedData.recMaxFrames ; // save the last-known maximum record length
	}


	if ("cameraModel" in parsedData)
		document.getElementById("cameraModel").innerHTML = "Camera Model: " + parsedData.cameraModel ;

	if ("cameraSerial" in parsedData)
		document.getElementById("serialNumber").innerHTML = "Serial Number: " + parsedData.cameraSerial ;

	if ("cameraApiVersion" in parsedData)
		document.getElementById("releaseVersion").innerHTML = "Release Version: " + parsedData.cameraApiVersion ;

	if ("cameraFpgaVersion" in parsedData)
		document.getElementById("FPGARev").innerHTML = "FPGA Revision: " + parsedData.cameraFpgaVersion ;

	if ("pmicFirmwareVersion" in parsedData)
		document.getElementById("PMICVersion").innerHTML = "PMIC Firmware Version: " + parsedData.pmicFirmwareVersion ;

	if ("sensorTemperature" in parsedData)
		document.getElementById("sensorTemp").innerHTML = "Sensor Temperature: " + parsedData.sensorTemperature + " &deg;C" ;

	if ("systemTemperature" in parsedData)
		document.getElementById("systemTemp").innerHTML = "System Temperature: " + parsedData.systemTemperature + " &deg;C" ;

	if ("lastShutdownReason" in parsedData)
		document.getElementById("shutdownReason").innerHTML = "Last Shutdown Reason: " + parsedData.lastShutdownReason ;

	if ("sensorColorPattern" in parsedData) { // check if camera is color or black & white
		if (parsedData.sensorColorPattern == "GRBG")
			document.getElementById("cameraType").innerHTML = "Color" ;
		else {
			document.getElementById("cameraType").innerHTML = "Monochrome" ;

			document.getElementById("colourMatrixBox").classList.add("hidden") ; // hide the color matrix box
			document.getElementById("whiteBalanceBox").classList.add("hidden") ; // hide the white balance box
		}

	}


	if ("recTrigDelay" in parsedData) {
		if (document.getElementById("postTriggerFrameNum") != document.activeElement)
			document.getElementById("postTriggerFrameNum").value = parsedData.recTrigDelay ; // set the number of frames

		if (parsedData.recTrigDelay > lastKnownMaxRecFrames) { // pre-record delay is being used
			while (parsedData.recTrigDelay > (lastKnownMaxRecFrames + extender))
				extender += lastKnownMaxRecFrames ; // increase the pre-record time until my value fits inside
				
			if (document.getElementById("preRecordFrameNum") != document.activeElement)
				document.getElementById("preRecordFrameNum").value = parsedData.recTrigDelay - lastKnownMaxRecFrames ;
			if (document.getElementById("preTriggerFrameNum") != document.activeElement)
				document.getElementById("preTriggerFrameNum").value = 0 ;
		}
		else {
			if (document.getElementById("preRecordFrameNum") != document.activeElement)
				document.getElementById("preRecordFrameNum").value = 0 ;
			if (document.getElementById("preTriggerFrameNum") != document.activeElement)
				document.getElementById("preTriggerFrameNum").value = lastKnownMaxRecFrames - parsedData.recTrigDelay ;
		}

		if (document.getElementById("postTriggerTime") != document.activeElement)
			document.getElementById("postTriggerTime").value = (parsedData.recTrigDelay * lastKnownFramePeriod / 1000000000).toFixed(4) ;
		if (document.getElementById("preTriggerTime") != document.activeElement)
			document.getElementById("preTriggerTime").value = (parseInt(document.getElementById("preTriggerFrameNum").value) * lastKnownFramePeriod / 1000000000).toFixed(4) ;
		if (document.getElementById("preRecordTime") != document.activeElement)
			document.getElementById("preRecordTime").value = (parseInt(document.getElementById("preRecordFrameNum").value) * lastKnownFramePeriod / 1000000000).toFixed(4) ;

		if (document.getElementById("postTriggerSlider") != document.activeElement) { // update slider value, max, and red background
			document.getElementById("postTriggerSlider").value = lastKnownMaxRecFrames + extender - parsedData.recTrigDelay ;
			document.getElementById("postTriggerSlider").max = lastKnownMaxRecFrames + extender ;
			document.getElementById("backgroundThing").style.borderLeftWidth = ( extender / (extender + lastKnownMaxRecFrames) * document.getElementById("postTriggerSlider").offsetWidth ) + "px" ;
		}
	}

	if ("externalStorage" in parsedData) { // get and build a list of external storage devices on the camera
		if ("nfs" in parsedData.externalStorage) {
			var nfsStorage = parsedData.externalStorage.nfs.device.split(":/") ;
			if (document.getElementById("nfsAddress") != document.activeElement)
				document.getElementById("nfsAddress").value = nfsStorage[0] ;
			if (document.getElementById("nfsMount") != document.activeElement)
				document.getElementById("nfsMount").value = nfsStorage[1] ;
			document.getElementById("nfsUnmountBtn").classList.remove("disabled") ;
			document.getElementById("nfsTestBtn").classList.remove("disabled") ;
		}
		else {
			document.getElementById("nfsUnmountBtn").classList.add("disabled") ;
			document.getElementById("nfsTestBtn").classList.add("disabled") ;
		}
		if ("smb" in parsedData.externalStorage) {
			var smbStorage = parsedData.externalStorage.smb.device.split("/") ;
			if (document.getElementById("smbAddress") != document.activeElement)
				document.getElementById("smbAddress").value = smbStorage[2] ;
			if (document.getElementById("smbMount") != document.activeElement)
				document.getElementById("smbMount").value = smbStorage[3] ;
			document.getElementById("smbUnmountBtn").classList.remove("disabled") ;
			document.getElementById("smbTestBtn").classList.remove("disabled") ;
		}
		else {
			document.getElementById("smbUnmountBtn").classList.add("disabled") ;
			document.getElementById("smbTestBtn").classList.add("disabled") ;
		}
	}
}



function dataRequester(method, parameter, callMeMaybe) {
	var requestSender = new XMLHttpRequest() ; // set up a new request
	requestSender.open("POST", "/control/" + method, true) ; // use "post", and use the /control/ method
	requestSender.setRequestHeader("Content-Type", "application/json") ; // use json format
	requestSender.withCredentials = true ;

	requestSender.onreadystatechange = function(){ // do something with the response
		if (this.readyState == 4 && this.status == 200){ // wait for successful response
			callMeMaybe(requestSender.responseText) ; // call the callback function with the response text
		}
	}

	requestSender.send(parameter) ;
}


function dataSender(method, parameter){
	var requestSender = new XMLHttpRequest() ;
	requestSender.open("POST", "/control/" + method, true) ;
	requestSender.setRequestHeader("Content-Type", "application/json") ;
	requestSender.withCredentials = true ;
	
	requestSender.send(parameter) ;
}

function dataGetter(method, parameter, callMeMaybe){
	var requestSender = new XMLHttpRequest() ;
	requestSender.open("GET", "/control/" + method + ( (parameter !== "") ? "?" + parameter : "")) ;
	requestSender.setRequestHeader("Content-Type", "application/json") ;

	requestSender.onreadystatechange = function(){ // do something with the response
		if (this.readyState == 4 && this.status == 200){
			callMeMaybe(requestSender.responseText) ; // call this function to deal with the input and update the page
			 // callback function, passing in the string we got back
		}
	}

	requestSender.send(parameter) ;
}

function detourRequester(method, parameter, callMeMaybe) {
	var requestSender = new XMLHttpRequest() ; // set up a new request
	requestSender.open("POST", "/cgi-bin/longWayAround", true) ; // use "post", and use the work around script for json arrays
	requestSender.setRequestHeader("Content-Type", "application/json") ; // use json format
	requestSender.withCredentials = true ;

	requestSender.onreadystatechange = function(){ // do something with the response
		if (this.readyState == 4 && this.status == 200){ // wait for successful response
			callMeMaybe(requestSender.responseText) ; // call the callback function with the response text
		}
	}

	requestSender.send(parameter) ;
}

var useServerSentEvents = true;

if (typeof(EventSource) != "undefined") {
	const evtSource = new EventSource("/control/subscribe");

	evtSource.onmessage = function(event) {
		if (DebugOnOff)
			document.getElementById("debugger").innerHTML = "onmessage:" + event.data;
	}
	evtSource.addEventListener("notify", function(event) {pageUpdate(event.data);}, false);
	evtSource.addEventListener("complete", function(event) { pageUpdate(event.data) ; if (DebugOnOff) document.getElementById("debugger").innerHTML = "got complete:" + event.data; }, false);
}
else {
	useServerSentEvents = false;
document.getElementById("refreshAllBox").classList.remove("hidden") ;
}

dataGetter("p", "", pageUpdate) ; // get all the data on startup



var PollCounter = 1 ;
function pollOnlyUpdates() { // some information I can only get if I ask for it, so that's what I do here

	if (PollCounter % 2 == 0) { // every 1 second

	}

	if (PollCounter % 30 == 0) { // every 15-ish seconds
		dataGetter('get', 'batteryChargePercent', pageUpdate) ; // ask for the battery charge level
	}

	if (PollCounter % 120 == 0) { // every 60-ish seconds
		dataGetter('get', 'externalStorage', pageUpdate) ; // ask for the external storage devices
	}


	if (!useServerSentEvents) { // no server-sent events; ask for updates

		if (PollCounter % 31 == 0)
			dataGetter('get', 'externalPower', pageUpdate) ; // check for external power connection

	}

	PollCounter++ ;
}



/* check cookies */

switch (getCookie("thm")) {
	case "":
		setCookie("thm", "dt") ;
	case "dt":
		theme("default") ;
		break ;

	case "mo":
		theme("monochrome") ;
		break ;

	case "dk":
		theme("darker") ;
		break ;

	case "lt":
		theme("lighter") ;
		break ;

	case "md":
		theme("monoDark") ;
		break ;

	case "l2":
		theme("newDefault") ;
		break ;
}

switch (getCookie("fpl")) {
	case "":
		setCookie("fpl", 0.67) ; // set to Medium
	case "0.67":
		document.getElementById("focusPeakingLevelDropdown").firstChild.textContent = "Medium" ;
		break ;

	case "0.33":
		document.getElementById("focusPeakingLevelDropdown").firstChild.textContent = " Low " ;
		break ;

	case "1.0":
	case "1":
		document.getElementById("focusPeakingLevelDropdown").firstChild.textContent = " High " ;
		break ;
}


switch (getCookie("wo")) {
	case "":
		setCookie("wo", "u") ;
	case "u":
		document.getElementById("recordWarn").firstChild.textContent = "If Unsaved" ;
		break ;

	case "a":
		document.getElementById("recordWarn").firstChild.textContent = "Always" ;
		break ;

	case "n":
		document.getElementById("recordWarn").firstChild.textContent = "Never";
		break ;
}

switch (getCookie("mc")) {
	case "":
		setCookie("mc", "n") ; // default is 'on navigation'
	case "m":
		document.getElementById("changeModeDropdown").firstChild.textContent = "Manually" ;
		break ;

	case "n":
		document.getElementById("changeModeDropdown").firstChild.textContent = "On Navigation" ;
		break ;
}


	stateSelecter(document.getElementById("autoSaveButton"), (getCookie("as") > 0)) ;


/*
	Cookie Descriptions:

	id	name / description
	---|-----------------------|
	fpl	"focus peaking level"	number from 0 to 1
	mc	"mode change"			"n" to change mode on navigation, "m" to change mode manually
	sr	"save recording"		0 when recording was saved, 1 when not saved
	thm	"theme"					2-letter code to indicate each theme
	wo	"warn overwrite"		"a" always warn, "n" never warn, "u" warn on unsaved recordings
	as	"auto save"				<= 0 to not auto save, > 0 to select device to save on
	ff	"file format"			0: H264, 1: DNG, 2: Tiff12, 3: Tiff16(Raw)

*/


var intervalID = setInterval(pollOnlyUpdates, 500) ; // poll the camera for things that are not reported





</script>
</html>




